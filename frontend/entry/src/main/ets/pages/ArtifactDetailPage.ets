import router from '@ohos.router';
import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
import ApiConstants from '../common/constants/ApiConstants';
import { UserService } from '../common/utils/UserService';

// å®šä¹‰HTTPé”™è¯¯ç±»å‹
interface HttpError {
  code?: number;
  message?: string;
}

// å®šä¹‰æ–‡ç‰©æ¥å£ - ä¸å…¶ä»–é¡µé¢ä¿æŒä¸€è‡´
interface Artifact {
  id: number;            // ä½¿ç”¨idä½œä¸ºä¸»é”®ï¼Œä¸åç«¯ä¿æŒä¸€è‡´
  name: string;
  era: string;
  type: string;
  museum: string;
  description: string;
  imageUrl: string;
  likes: number;
  feature?: string;
  isCollected?: boolean; // æ·»åŠ æ˜¯å¦å·²æ”¶è—çš„æ ‡è®°
  isLiked?: boolean;     // æ·»åŠ æ˜¯å¦å·²ç‚¹èµçš„æ ‡è®°
  // å…¼å®¹æ€§å­—æ®µï¼Œä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨äº†artifactId
  artifactId?: number;
}

// å®šä¹‰è¯„è®ºæ¥å£
interface Comment {
  commentId: number;
  content: string;
  publishTime: string;
  userId: number;
  username: string;
  reviewStatus?: string; // æ·»åŠ å®¡æ ¸çŠ¶æ€å­—æ®µ
}

// å®šä¹‰è¯„è®ºæäº¤æ•°æ®æ¥å£
interface CommentRequest {
  content: string;
  artifactId: number;
  userId: number;
}

// æ›¿æ¢ç´¢å¼•ç­¾åï¼Œä½¿ç”¨æ˜ç¡®å±æ€§å®šä¹‰
interface CollectionResult {
  id?: number;
  success?: boolean;
  status?: string;
  count?: number;
  value?: string;
  // å…¶ä»–å¯èƒ½çš„å±æ€§...
}

// æ·»åŠ APIå“åº”æ¥å£å®šä¹‰ï¼Œä¿®å¤ä¸ºæ›´ä¸¥æ ¼çš„ç±»å‹ä»¥åŒ¹é…åç«¯
interface ApiResponse<T> {
  success: boolean;
  message?: string;
  data?: T;
  hasLiked?: boolean;
}

// æ·»åŠ æµè§ˆå†å²è¯·æ±‚æ¥å£å®šä¹‰
interface BrowseHistoryRequest {
  userId: number;
  artifactId: number;
  browseTime?: string; // å¯é€‰ï¼ŒæœåŠ¡å™¨ç«¯å¯è‡ªåŠ¨ç”Ÿæˆæ—¶é—´
}

// æ·»åŠ æ›´å…·ä½“çš„å“åº”ç±»å‹å®šä¹‰
interface BrowseHistoryResponse {
  success: boolean;
  message?: string;
}

interface LikeResponse {
  success: boolean;
  message?: string;
  count?: number; // å¯èƒ½è¿”å›çš„æœ€æ–°ç‚¹èµæ•°
}

interface CollectionResponse {
  success: boolean;
  message?: string;
  id?: number; // æ”¶è—ID
}

// å‚æ•°æ¥å£å®šä¹‰ - æ”¯æŒå¤šç§å¯èƒ½çš„å‚æ•°åï¼Œä½†ä»¥idä¸ºä¸»
interface RouterParams {
  id?: string | number;             // æ ‡å‡†åç§°ï¼Œä¸åç«¯ä¿æŒä¸€è‡´
  artifactId?: string | number;     // å…¼å®¹æ—§ä»£ç 
  artifact_id?: string | number;    // å…¼å®¹snake_caseå‘½å
  artifact?: Artifact;              // æ¥æ”¶å®Œæ•´å¯¹è±¡
  uri?: string;                     // å…¶ä»–å‚æ•°
}

// æ·»åŠ æ”¶è—è¯·æ±‚æ¥å£å®šä¹‰
interface CollectionRequest {
  userId: number;
  artifactId: number;
}

@Entry
@Component
struct ArtifactDetailPage {
  @State artifact: Artifact = {} as Artifact;
  @State comments: Comment[] = [];
  @State isLoading: boolean = true;
  @State isLoadingComments: boolean = true;
  @State errorMsg: string = '';
  @State isCollected: boolean = false; // æ·»åŠ æ”¶è—çŠ¶æ€
  @State isLiked: boolean = false;     // æ·»åŠ ç‚¹èµçŠ¶æ€
  @State commentText: string = ''; // æ·»åŠ è¯„è®ºæ–‡æœ¬çŠ¶æ€
  @State isSubmittingComment: boolean = false; // æ·»åŠ è¯„è®ºæäº¤çŠ¶æ€
  @State editingCommentId: number = -1; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„è¯„è®ºIDï¼Œ-1è¡¨ç¤ºæ²¡æœ‰ç¼–è¾‘çŠ¶æ€
  @State editingCommentText: string = ''; // ç¼–è¾‘çŠ¶æ€ä¸‹çš„è¯„è®ºæ–‡æœ¬
  @State isEditingComment: boolean = false; // æ˜¯å¦åœ¨ç¼–è¾‘è¯„è®º

  private artifactId: number = 0;
  private httpRequest = http.createHttp();
  private userService: UserService = UserService.getInstance(); // ä½¿ç”¨ç”¨æˆ·æœåŠ¡
  private currentUserId: number = 2; // å½“å‰ç”¨æˆ·IDï¼Œå°†ä»ç”¨æˆ·æœåŠ¡è·å–

  // æ·»åŠ æµè§ˆè®°å½•ç›¸å…³å˜é‡
  private viewStartTime: number = 0; // é¡µé¢æ‰“å¼€æ—¶é—´
  private viewThreshold: number = 30000; // 30ç§’é˜ˆå€¼ï¼Œå•ä½æ¯«ç§’
  private viewTimerID: number = -1; // å®šæ—¶å™¨ID
  private hasRecorded: boolean = false; // æ˜¯å¦å·²è®°å½•æµè§ˆå†å²

  aboutToAppear() {
    // ä»ç”¨æˆ·æœåŠ¡è·å–å½“å‰ç”¨æˆ·ID
    this.currentUserId = this.userService.getCurrentUserId();

    // è·å–è·¯ç”±å‚æ•°ä¸­çš„æ–‡ç‰©ID - å¢å¼ºå¥å£®æ€§
    const params = router.getParams() as RouterParams;
    console.info(`æ¥æ”¶åˆ°çš„è·¯ç”±å‚æ•°: ${JSON.stringify(params)}`);

    // å…¼å®¹å¤šç§å¯èƒ½çš„IDå­—æ®µå
    let artifactIdValue: string | number | undefined = undefined;

    if (params) {
      // æ›¿æ¢ä¸æ”¯æŒçš„åŠ¨æ€ç´¢å¼•è®¿é—®æ–¹å¼ï¼Œæ”¹ä¸ºç›´æ¥è®¿é—®å·²çŸ¥å±æ€§
      console.info(`å‚æ•°ç±»å‹: ${typeof params}`);

      // ç›´æ¥æ‰“å°å·²çŸ¥å¯èƒ½å­˜åœ¨çš„å…³é”®å‚æ•°ï¼Œé¿å…ä½¿ç”¨Object.keys()å’Œç´¢å¼•è®¿é—®
      console.info(`å‚æ•° id: ${JSON.stringify(params.id)}`);
      console.info(`å‚æ•° artifactId: ${JSON.stringify(params.artifactId)}`);
      console.info(`å‚æ•° artifact_id: ${JSON.stringify(params.artifact_id)}`);
      console.info(`å‚æ•° artifact: ${JSON.stringify(params.artifact)}`);
      console.info(`å‚æ•° uri: ${JSON.stringify(params.uri)}`);

      // ä¼˜å…ˆæ£€æŸ¥æ ‡å‡†çš„idå­—æ®µ
      if (params.id !== undefined) {
        artifactIdValue = params.id;
        console.info(`æ‰¾åˆ°å‚æ•°id: ${artifactIdValue}`);
      }
      // å…¶æ¬¡æ£€æŸ¥å®Œæ•´æ–‡ç‰©å¯¹è±¡
      else if (params.artifact && typeof params.artifact === 'object') {
        const artifactObj = params.artifact as Artifact;
        console.info(`æ‰¾åˆ°å®Œæ•´çš„artifactå¯¹è±¡: ${JSON.stringify(artifactObj)}`);

        if (artifactObj.id !== undefined) {
          artifactIdValue = artifactObj.id;
          console.info(`ä»artifactå¯¹è±¡ä¸­æå–id: ${artifactIdValue}`);

          // å¦‚æœæ‰¾åˆ°äº†IDï¼Œä½¿ç”¨å¯¹è±¡çš„å…¶ä»–å±æ€§ä½œä¸ºåˆå§‹æ•°æ®
          this.artifact = artifactObj;
        }
        // å…¼å®¹ä½¿ç”¨artifactIdçš„æƒ…å†µ
        else if (artifactObj.artifactId !== undefined) {
          artifactIdValue = artifactObj.artifactId;
          console.info(`ä»artifactå¯¹è±¡ä¸­æå–artifactId: ${artifactIdValue}`);

          // å¦‚æœæ‰¾åˆ°äº†IDï¼Œä½¿ç”¨å¯¹è±¡çš„å…¶ä»–å±æ€§ä½œä¸ºåˆå§‹æ•°æ®
          this.artifact = artifactObj;
        }
      }
      // æœ€åæ£€æŸ¥å…¶ä»–å¯èƒ½çš„IDå‘½å
      else if (params.artifactId !== undefined) {
        artifactIdValue = params.artifactId;
        console.info(`æ‰¾åˆ°å‚æ•°artifactId: ${artifactIdValue}`);
      } else if (params.artifact_id !== undefined) {
        artifactIdValue = params.artifact_id;
        console.info(`æ‰¾åˆ°å‚æ•°artifact_id: ${artifactIdValue}`);
      }

      // å°è¯•ä»URLä¸­æå–ID (å…¼å®¹/artifacts/123æ ¼å¼)
      if (artifactIdValue === undefined && params.uri) {
        const uriString = params.uri.toString();
        const matches = uriString.match(/\/artifacts\/(\d+)/);
        if (matches && matches[1]) {
          artifactIdValue = matches[1];
          console.info(`ä»URIè·¯å¾„æå–ID: ${artifactIdValue}`);
        }
      }
    }

    // å¤„ç†æ‰¾åˆ°çš„IDå€¼
    if (artifactIdValue !== undefined) {
      // è½¬æ¢ä¸ºæ•°å­—
      try {
        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸ºæ•´æ•°
        if (typeof artifactIdValue === 'string') {
          this.artifactId = parseInt(artifactIdValue);
        } else {
          // å·²ç»æ˜¯æ•°å­—ç±»å‹
          this.artifactId = artifactIdValue as number;
        }
        console.info(`å°†åŠ è½½æ–‡ç‰©è¯¦æƒ…ï¼Œè§£æåID: ${this.artifactId}`);

        // åŠ è½½æ•°æ®
        this.loadArtifactDetail();
        this.loadComments();
        this.checkCollectionStatus();
        this.checkLikeStatus();

        // è®¾ç½®æµè§ˆè®°å½•ç›¸å…³å‚æ•°
        this.viewStartTime = Date.now();
        this.hasRecorded = false;

        // è®¾ç½®å®šæ—¶å™¨ï¼Œå½“ç”¨æˆ·æµè§ˆæ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶è®°å½•æµè§ˆå†å²
        this.viewTimerID = setTimeout(() => {
          if (!this.hasRecorded && this.currentUserId > 0) {
            this.recordBrowseHistory();
          }
        }, 20000);

      } catch (e) {
        console.error(`è§£ææ–‡ç‰©IDå¤±è´¥: ${e.toString()}, åŸå§‹å€¼: ${artifactIdValue}`);
        this.errorMsg = `æ— æ³•è¯†åˆ«æ–‡ç‰©ID: ${artifactIdValue}`;
        this.isLoading = false;
      }
    } else {
      console.error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ–‡ç‰©IDå‚æ•°');
      this.errorMsg = 'æœªæ‰¾åˆ°æ–‡ç‰©IDä¿¡æ¯';
      this.isLoading = false;

      // æ˜¾ç¤ºé”™è¯¯æç¤º
      promptAction.showToast({
        message: 'æ‰¾ä¸åˆ°æ–‡ç‰©IDï¼Œæ— æ³•åŠ è½½è¯¦æƒ…',
        duration: 3000
      });
    }
  }

  aboutToDisappear() {
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.viewTimerID !== -1) {
      clearTimeout(this.viewTimerID);
      this.viewTimerID = -1;
    }

    if (this.httpRequest) {
      this.httpRequest.destroy();
    }
  }
  // è®°å½•æµè§ˆå†å²
  recordBrowseHistory() {
    if (this.hasRecorded || this.currentUserId <= 0 || this.artifactId <= 0) {
      return;
    }

    const url = ApiConstants.getFullUrl(ApiConstants.API_ADD_BROWSE_HISTORY);
    console.info(`å¼€å§‹è®°å½•æµè§ˆå†å²ï¼Œç”¨æˆ·ID: ${this.currentUserId}ï¼Œæ–‡ç‰©ID: ${this.artifactId}`);

    try {
      // æ„é€ è¯·æ±‚æ•°æ®
      const requestData: BrowseHistoryRequest = {
        userId: this.currentUserId,
        artifactId: this.artifactId
      };

      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json'
          },
          extraData: JSON.stringify(requestData),
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              const result: ApiResponse<BrowseHistoryResponse> = JSON.parse(resultStr);

              if (result.success) {
                console.info('æµè§ˆå†å²è®°å½•æˆåŠŸ');
                this.hasRecorded = true;
              } else {
                console.error('æµè§ˆå†å²è®°å½•å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
              }
            } catch (e) {
              console.error(`è§£ææµè§ˆå†å²å“åº”å¤±è´¥: ${e.toString()}`);
            }
          } else {
            console.error(`è®°å½•æµè§ˆå†å²å¤±è´¥: ${err?.message || 'æœªçŸ¥é”™è¯¯'}`);
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·æµè§ˆå†å²è¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
    }
  }

  // æ£€æŸ¥æ–‡ç‰©ç‚¹èµçŠ¶æ€
  checkLikeStatus() {
    const url = `${ApiConstants.getFullUrl(ApiConstants.API_LIKE_CHECK)}?artifactId=${this.artifactId}&userId=${this.currentUserId}`;

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              const result: ApiResponse<boolean> = JSON.parse(resultStr);

              if (result.success) {
                this.isLiked = result.hasLiked || false;
                this.artifact.isLiked = this.isLiked;
                console.info(`æ–‡ç‰©ç‚¹èµçŠ¶æ€æ£€æŸ¥ç»“æœï¼š${this.isLiked ? 'å·²ç‚¹èµ' : 'æœªç‚¹èµ'}`);
              }
            } catch (e) {
              console.error(`è§£æç‚¹èµçŠ¶æ€å¤±è´¥: ${e.toString()}`);
            }
          } else {
            console.error(`æ£€æŸ¥ç‚¹èµçŠ¶æ€å¤±è´¥: ${err?.message || 'æœªçŸ¥é”™è¯¯'}`);
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·ç‚¹èµçŠ¶æ€æ£€æŸ¥å¼‚å¸¸: ${e.toString()}`);
    }
  }

  // ç‚¹èµæˆ–å–æ¶ˆç‚¹èµ
  toggleLike() {
    const url = ApiConstants.getFullUrl(this.isLiked ? ApiConstants.API_UNLIKE : ApiConstants.API_LIKE);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          extraData: JSON.stringify({
            artifactId: this.artifactId,
            userId: this.currentUserId
          }),
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              const result: ApiResponse<LikeResponse> = JSON.parse(resultStr);

              if (result.success) {
                // æ›´æ–°ç‚¹èµçŠ¶æ€
                this.isLiked = !this.isLiked;
                this.artifact.isLiked = this.isLiked;

                // æ— è®ºåç«¯æ˜¯å¦è¿”å›ç‚¹èµæ•°ï¼Œéƒ½ç›´æ¥æŸ¥è¯¢æ–‡ç‰©è¯¦æƒ…è·å–æœ€æ–°ç‚¹èµæ•°
                this.getLatestLikeCount();

                promptAction.showToast({
                  message: this.isLiked ? 'ç‚¹èµæˆåŠŸ' : 'å–æ¶ˆç‚¹èµæˆåŠŸ',
                  duration: 2000
                });
              } else {
                promptAction.showToast({
                  message: result.message || 'æ“ä½œå¤±è´¥',
                  duration: 2000
                });                console.error(`ç‚¹èµæ“ä½œå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
              }
            } catch (e) {
              console.error(`è§£æç‚¹èµæ“ä½œå“åº”å¤±è´¥: ${e.toString()}`);
              promptAction.showToast({
                message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•',
                duration: 2000
              });
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            console.error(`ç‚¹èµæ“ä½œè¯·æ±‚å¤±è´¥: ${errMsg}`);
            promptAction.showToast({
              message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
              duration: 2000
            });
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·ç‚¹èµæ“ä½œè¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      promptAction.showToast({
        message: 'ç½‘ç»œè¿æ¥å¼‚å¸¸',
        duration: 2000
      });
    }
  }

  // è·å–æœ€æ–°çš„ç‚¹èµæ•°
  getLatestLikeCount() {
    const url = ApiConstants.getFullUrl(`/api/artifacts/likes/${this.artifactId}`);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              const result: ApiResponse<number> = JSON.parse(resultStr);

              if (result.success && result.data !== undefined && typeof result.data === 'number') {
                // åªæ›´æ–°ç‚¹èµæ•°ï¼Œä¸é‡æ–°åŠ è½½æ•´ä¸ªæ–‡ç‰©è¯¦æƒ…
                this.artifact.likes = result.data as number;
                console.info(`è·å–æœ€æ–°ç‚¹èµæ•°æˆåŠŸ: ${this.artifact.likes}`);
              } else {
                console.error('è·å–æœ€æ–°ç‚¹èµæ•°å¤±è´¥ï¼Œå°†é‡æ–°åŠ è½½æ–‡ç‰©è¯¦æƒ…');
                this.loadArtifactDetail();
              }
            } catch (e) {
              console.error(`è§£æç‚¹èµæ•°å“åº”å¤±è´¥: ${e.toString()}`);
              // å‡ºé”™æ—¶å›é€€åˆ°å®Œæ•´åŠ è½½
              this.loadArtifactDetail();
            }
          } else {
            console.error(`è·å–æœ€æ–°ç‚¹èµæ•°è¯·æ±‚å¤±è´¥: ${err?.message || 'æœªçŸ¥é”™è¯¯'}`);
            // å‡ºé”™æ—¶å›é€€åˆ°å®Œæ•´åŠ è½½
            this.loadArtifactDetail();
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·è·å–ç‚¹èµæ•°è¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      // å‡ºé”™æ—¶å›é€€åˆ°å®Œæ•´åŠ è½½
      this.loadArtifactDetail();
    }
  }

  // æ£€æŸ¥æ–‡ç‰©æ˜¯å¦å·²æ”¶è—
  checkCollectionStatus() {
    // æ„å»ºAPI URLï¼Œå¢åŠ userIdå‚æ•°
    const url = ApiConstants.getFullUrl(`/api/collection/check?artifactId=${this.artifactId}&userId=${this.currentUserId}`);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              console.info(`æ”¶è—çŠ¶æ€æ£€æŸ¥å“åº”: ${resultStr}`);

              // ä¿®å¤: æ·»åŠ æ˜ç¡®çš„ç±»å‹æ³¨è§£
              const result: ApiResponse<boolean> = JSON.parse(resultStr);
              if (result.success) {
                this.isCollected = result.data as boolean || false;
                console.info(`æ”¶è—çŠ¶æ€æ£€æŸ¥ç»“æœ: ${this.isCollected ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);
              }
            } catch (e) {
              console.error(`è§£ææ”¶è—çŠ¶æ€å¤±è´¥: ${e.toString()}`);
            }
          } else {
            console.error(`æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥: ${err?.message || 'æœªçŸ¥é”™è¯¯'}`);
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·æ”¶è—çŠ¶æ€æ£€æŸ¥å¼‚å¸¸: ${e.toString()}`);
    }
  }

  // æ·»åŠ æˆ–ç§»é™¤æ”¶è—
  toggleCollection() {
    const url = ApiConstants.getFullUrl(this.isCollected ? ApiConstants.API_REMOVE_COLLECTION : ApiConstants.API_ADD_COLLECTION);

    try {
      // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œç¡®ä¿åŒ…å«userId
      const requestData: CollectionRequest = {
        userId: this.currentUserId, // æ·»åŠ ç”¨æˆ·ID
        artifactId: this.artifactId
      };

      console.info(`å‘èµ·${this.isCollected ? 'å–æ¶ˆ' : 'æ·»åŠ '}æ”¶è—è¯·æ±‚ï¼šuserId=${requestData.userId}, artifactId=${requestData.artifactId}`);

      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer token' // TODO: æ·»åŠ å®é™…token
          },
          extraData: JSON.stringify(requestData), // ä¼ é€’å®Œæ•´æ•°æ®å¯¹è±¡
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              // ä¿®å¤: æ·»åŠ æ˜ç¡®çš„ç±»å‹æ³¨è§£
              const result: ApiResponse<CollectionResponse> = JSON.parse(resultStr);

              if (result.success) {
                this.isCollected = !this.isCollected;
                promptAction.showToast({
                  message: this.isCollected ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—æˆåŠŸ',
                  duration: 2000
                });
              } else {
                promptAction.showToast({
                  message: result.message || 'æ“ä½œå¤±è´¥',
                  duration: 2000
                });
              }
            } catch (e) {
              console.error(`è§£ææ”¶è—æ“ä½œå“åº”å¤±è´¥: ${e.toString()}`);
              promptAction.showToast({
                message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•',
                duration: 2000
              });
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            console.error(`æ”¶è—æ“ä½œè¯·æ±‚å¤±è´¥: ${errMsg}`);
            promptAction.showToast({
              message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
              duration: 2000
            });
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·æ”¶è—æ“ä½œè¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      promptAction.showToast({
        message: 'ç½‘ç»œè¿æ¥å¼‚å¸¸',
        duration: 2000
      });
    }
  }

  // åŠ è½½æ–‡ç‰©è¯¦æƒ… - å¢å¼ºé”™è¯¯å¤„ç†
  loadArtifactDetail() {
    this.isLoading = true;

    // éªŒè¯ID
    if (!this.artifactId || this.artifactId <= 0) {
      this.errorMsg = 'æ— æ•ˆçš„æ–‡ç‰©ID: ' + this.artifactId;
      this.isLoading = false;
      return;
    }

    const url = ApiConstants.getFullUrl(`${ApiConstants.API_ARTIFACT_DETAIL}${this.artifactId}`);
    console.info(`è¯·æ±‚æ–‡ç‰©è¯¦æƒ…: ${url}, æ–‡ç‰©ID: ${this.artifactId}`);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              console.info(`æ”¶åˆ°æ–‡ç‰©è¯¦æƒ…å“åº”: ${data.result}`);
              const resultStr = data.result ? data.result.toString() : '{}';

              // ä¿®æ”¹ï¼šé¦–å…ˆå°è¯•å°†å“åº”è§£æä¸ºæ–‡ç‰©å¯¹è±¡
              try {
                // ç›´æ¥è§£æä¸ºæ–‡ç‰©å¯¹è±¡
                const directArtifact: Artifact = JSON.parse(resultStr);

                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ–‡ç‰©å¯¹è±¡ (è‡³å°‘æœ‰idå’Œname)
                if (directArtifact && directArtifact.id !== undefined && directArtifact.name) {
                  console.info(`ç›´æ¥è§£ææ–‡ç‰©å¯¹è±¡æˆåŠŸ: ${directArtifact.name}`);
                  this.artifact = directArtifact;
                  this.isLoading = false;
                  return;
                }
              } catch (directParseError) {
                // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•è§£æä¸ºAPIå“åº”æ ¼å¼
                console.warn(`ç›´æ¥è§£ææ–‡ç‰©å¯¹è±¡å¤±è´¥ï¼Œå°è¯•è§£æä¸ºAPIå“åº”æ ¼å¼: ${directParseError}`);
              }

              // åå¤‡æ–¹æ¡ˆï¼šå°è¯•è§£æä¸ºAPIåŒ…è£…æ ¼å¼ {success: boolean, data: Artifact}
              const apiResponse: ApiResponse<Artifact> = JSON.parse(resultStr);

              // æ£€æŸ¥APIå“åº”ä¸­æ˜¯å¦åŒ…å«æˆåŠŸæ ‡å¿—å’Œæœ‰æ•ˆæ•°æ®
              if (apiResponse.success && apiResponse.data) {
                // ä»å“åº”çš„dataå­—æ®µä¸­æå–æ–‡ç‰©å¯¹è±¡
                this.artifact = apiResponse.data;

                // è¾“å‡ºå®Œæ•´çš„æ–‡ç‰©å¯¹è±¡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯å›¾ç‰‡URL
                console.info(`è§£ææ–‡ç‰©è¯¦æƒ…æˆåŠŸï¼Œå®Œæ•´æ•°æ®: ${JSON.stringify(this.artifact)}`);
                console.info(`å›¾ç‰‡URL: ${this.artifact.imageUrl || 'æœªæä¾›å›¾ç‰‡URL'}`);

                // å¦‚æœåç«¯APIç›´æ¥è¿”å›äº†æ”¶è—çŠ¶æ€ï¼Œæ›´æ–°isCollected
                if (this.artifact.isCollected !== undefined) {
                  this.isCollected = this.artifact.isCollected;
                }

                console.info(`è§£ææ–‡ç‰©è¯¦æƒ…æˆåŠŸ: ${this.artifact.name}`);
              } else {
                // å¦‚æœAPIå“åº”ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯
                this.errorMsg = apiResponse.message || 'æœªæ‰¾åˆ°æ–‡ç‰©ä¿¡æ¯';
                console.error(`APIè¿”å›é”™è¯¯: ${this.errorMsg}`);
              }
            } catch (e) {
              console.error(`è§£ææ–‡ç‰©è¯¦æƒ…å¤±è´¥: ${e.toString()}`);
              this.errorMsg = `è§£ææ–‡ç‰©è¯¦æƒ…å¤±è´¥: ${e.toString()}`;
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            const respCode = data ? data.responseCode.toString() : 'N/A';
            console.error(`è¯·æ±‚æ–‡ç‰©è¯¦æƒ…å¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`);
            this.errorMsg = `ç½‘ç»œè¯·æ±‚å¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`;
          }
          this.isLoading = false;
        }
      );
    } catch (e) {
      console.error(`å‘èµ·æ–‡ç‰©è¯¦æƒ…è¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      this.errorMsg = `å‘èµ·è¯·æ±‚å¼‚å¸¸: ${e.toString()}`;
      this.isLoading = false;
    }
  }

  // åŠ è½½è¯„è®º
  loadComments() {
    this.isLoadingComments = true;
    // ä¿®æ”¹URLæ ¼å¼ï¼Œä½¿ç”¨æŸ¥è¯¢å‚æ•°æ ¼å¼ä¸åç«¯APIåŒ¹é…ï¼Œå¹¶ä¼ é€’å½“å‰ç”¨æˆ·ID
    const url = ApiConstants.getFullUrl(`${ApiConstants.API_COMMENTS}?artifactId=${this.artifactId}&userId=${this.currentUserId}`);

    console.info(`è¯·æ±‚è¯„è®º: ${url}`);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              console.info(`æ”¶åˆ°è¯„è®ºå“åº”: ${data.result}`);
              const resultStr = data.result ? data.result.toString() : '[]';
              this.comments = JSON.parse(resultStr);
              console.info(`è§£æè¯„è®ºæˆåŠŸï¼Œè·å–äº†${this.comments.length}æ¡è¯„è®º`);
            } catch (e) {
              console.error(`è§£æè¯„è®ºå¤±è´¥: ${e.toString()}`);
              // ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            const respCode = data ? data.responseCode.toString() : 'N/A';
            console.error(`è¯·æ±‚è¯„è®ºå¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`);
            // ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
          }
          this.isLoadingComments = false;
        }
      );
    } catch (e) {
      console.error(`å‘èµ·è¯„è®ºè¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      this.isLoadingComments = false;
    }
  }

  // æ·»åŠ æäº¤è¯„è®ºçš„æ–¹æ³•
  submitComment() {
    if (!this.commentText || this.commentText.trim() === '') {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹',
        duration: 2000
      });
      return;
    }

    if (this.isSubmittingComment) {
      return; // é¿å…é‡å¤æäº¤
    }

    this.isSubmittingComment = true;
    const url = ApiConstants.getFullUrl(ApiConstants.API_COMMENTS);

    // æ„å»ºè¯„è®ºæ•°æ®
    const commentData: CommentRequest = {
      content: this.commentText.trim(),
      artifactId: this.artifactId,
      userId: this.currentUserId // ä¿®æ”¹ï¼šä½¿ç”¨å½“å‰ç”¨æˆ·IDï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„å€¼
    };

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': 'Bearer token' // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æœ‰æ•ˆçš„token
          },
          extraData: JSON.stringify(commentData),
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          this.isSubmittingComment = false;

          if (!err && (data.responseCode === 200 || data.responseCode === 201)) {
            try {
              console.info(`è¯„è®ºæäº¤æˆåŠŸ: ${data.result}`);
              promptAction.showToast({
                message: 'è¯„è®ºå‘è¡¨æˆåŠŸï¼Œç­‰å¾…å®¡æ ¸',
                duration: 2000
              });

              // æ¸…ç©ºè¯„è®ºæ–‡æœ¬
              this.commentText = '';

              // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
              this.loadComments();
            } catch (e) {
              console.error(`è§£æè¯„è®ºæäº¤å“åº”å¤±è´¥: ${e.toString()}`);
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            const respCode = data ? data.responseCode.toString() : 'N/A';
            console.error(`è¯„è®ºæäº¤å¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`);

            promptAction.showToast({
              message: 'è¯„è®ºæäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
              duration: 2000
            });
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·è¯„è®ºæäº¤å¼‚å¸¸: ${e.toString()}`);
      this.isSubmittingComment = false;

      promptAction.showToast({
        message: 'è¯„è®ºæäº¤å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
        duration: 2000
      });
    }
  }

  // æ·»åŠ åˆ é™¤è¯„è®ºæ–¹æ³•
  deleteComment(commentId: number) {
    const url = ApiConstants.getFullUrl(`${ApiConstants.API_COMMENTS}/${commentId}`);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.DELETE,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer token' // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æœ‰æ•ˆçš„token
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 204) {
            // åˆ é™¤æˆåŠŸï¼ŒçŠ¶æ€ç 204è¡¨ç¤ºNo Content
            console.info(`è¯„è®ºåˆ é™¤æˆåŠŸ, ID: ${commentId}`);

            // ä»åˆ—è¡¨ä¸­ç§»é™¤è¯¥è¯„è®º
            this.comments = this.comments.filter(item => item.commentId !== commentId);

            promptAction.showToast({
              message: 'è¯„è®ºå·²åˆ é™¤',
              duration: 2000
            });
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            const respCode = data ? data.responseCode.toString() : 'N/A';
            console.error(`åˆ é™¤è¯„è®ºå¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`);

            promptAction.showToast({
              message: 'åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•',
              duration: 2000
            });
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·åˆ é™¤è¯„è®ºè¯·æ±‚å¼‚å¸¸: ${e.toString()}`);

      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  // æ·»åŠ ç¼–è¾‘è¯„è®ºçš„æ–¹æ³•
  startEditComment(comment: Comment) {
    this.editingCommentId = comment.commentId;
    this.editingCommentText = comment.content;
    this.isEditingComment = true;
  }

  // å–æ¶ˆç¼–è¾‘è¯„è®º
  cancelEditComment() {
    this.editingCommentId = -1;
    this.editingCommentText = '';
    this.isEditingComment = false;
  }

  // ä¿å­˜ç¼–è¾‘åçš„è¯„è®º
  saveEditedComment() {
    if (!this.editingCommentText || this.editingCommentText.trim() === '') {
      promptAction.showToast({
        message: 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º',
        duration: 2000
      });
      return;
    }

    const url = ApiConstants.getFullUrl(`${ApiConstants.API_COMMENTS}/${this.editingCommentId}`);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.PUT,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer token' // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨æœ‰æ•ˆçš„token
          },
          extraData: JSON.stringify({
            content: this.editingCommentText.trim()
          }),
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              console.info(`è¯„è®ºç¼–è¾‘æˆåŠŸ: ${data.result}`);
              const resultStr = data.result ? data.result.toString() : '{}';
              const updatedComment: Comment = JSON.parse(resultStr);

              // æ›´æ–°æœ¬åœ°è¯„è®ºåˆ—è¡¨
              this.comments = this.comments.map(item => {
                if (item.commentId === this.editingCommentId) {
                  return updatedComment;
                }
                return item;
              });

              promptAction.showToast({
                message: 'è¯„è®ºå·²æ›´æ–°ï¼Œç­‰å¾…å®¡æ ¸',
                duration: 2000
              });

              // é‡ç½®ç¼–è¾‘çŠ¶æ€
              this.cancelEditComment();
            } catch (e) {
              console.error(`è§£æè¯„è®ºç¼–è¾‘å“åº”å¤±è´¥: ${e.toString()}`);

              promptAction.showToast({
                message: 'è¯„è®ºæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•',
                duration: 2000
              });
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            const respCode = data ? data.responseCode.toString() : 'N/A';
            console.error(`è¯„è®ºç¼–è¾‘å¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`);

            promptAction.showToast({
              message: 'è¯„è®ºæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•',
              duration: 2000
            });
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·è¯„è®ºç¼–è¾‘è¯·æ±‚å¼‚å¸¸: ${e.toString()}`);

      promptAction.showToast({
        message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(dateString: string): string {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    } catch (e) {
      return dateString;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›æŒ‰é’®
        Button({ type: ButtonType.Normal }) {
          // æ›¿æ¢ä¸ºæ–‡å­—æŒ‰é’®ï¼Œå› ä¸ºå›¾æ ‡èµ„æºä¸å­˜åœ¨
          Text('â†')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .height(40)
        .width(40)
        .backgroundColor('transparent')
        .onClick(() => {
          router.back();
        })

        // æ ‡é¢˜
        Text(this.isLoading ? 'æ–‡ç‰©è¯¦æƒ…' : this.artifact.name || 'æ–‡ç‰©è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å³ä¾§å ä½ï¼Œä½¿ç”¨é€æ˜æŒ‰é’®ä¿æŒå¸ƒå±€å¯¹ç§°
        Button({ type: ButtonType.Normal }) {
          Text('')
        }
        .height(40)
        .width(40)
        .backgroundColor('transparent')
        .opacity(0)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#FFFFFF')

      // ä¸»ä½“å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          if (this.isLoading) {
            // åŠ è½½ä¸­æ˜¾ç¤º
            Column() {
              LoadingProgress()
                .width(50)
                .height(50)
              Text('åŠ è½½ä¸­...')
                .fontSize(16)
                .fontColor('#999999')
                .margin({ top: 8 })
            }
            .height(300)
            .width('100%')
            .justifyContent(FlexAlign.Center)
          } else if (this.errorMsg !== '') {
            // é”™è¯¯ä¿¡æ¯
            Column() {
              Text(this.errorMsg)
                .fontSize(16)
                .fontColor('#FF0000')
            }
            .height(300)
            .width('100%')
            .justifyContent(FlexAlign.Center)
          } else {
            // æ–‡ç‰©è¯¦æƒ…å±•ç¤º
            Column() {              // æ–‡ç‰©å›¾ç‰‡
              Stack() {
                // æ— æ¡ä»¶æ˜¾ç¤ºå›¾ç‰‡ï¼Œå³ä½¿imageUrlå¯èƒ½ä¸ºç©ºï¼Œä¹Ÿå°è¯•åŠ è½½
                Image(this.artifact.imageUrl)
                  .width('100%')
                  .height(240)
                  .objectFit(ImageFit.Cover)
                  .onError(() => {
                    console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${this.artifact.imageUrl}`);
                  })
              }
              .width('100%')

              // æ–‡ç‰©åŸºæœ¬ä¿¡æ¯
              Column() {
                // æ–‡ç‰©åç§°
                Text(this.artifact.name || '')
                  .fontSize(22)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 16, bottom: 12 })
                // åŸºæœ¬ä¿¡æ¯æ 1 - å¹´ä»£å’Œç±»å‹
                Row() {
                  // å¹´ä»£
                  Column() {
                    Text('å¹´ä»£')
                      .fontSize(14)
                      .fontColor('#999999')
                    Text(this.artifact.era || 'æœªçŸ¥')
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Center)

                  Divider()
                    .vertical(true)
                    .height(30)
                    .color('#EEEEEE')

                  // ç±»å‹
                  Column() {
                    Text('ç±»å‹')
                      .fontSize(14)
                      .fontColor('#999999')
                    Text(this.artifact.type || 'æœªçŸ¥')
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Center)

                  Divider()
                    .vertical(true)
                    .height(30)
                    .color('#EEEEEE')

                  // ç‚¹èµæ•°
                  Column() {
                    Text('ç‚¹èµ')
                      .fontSize(14)                      .fontColor('#999999')
                    Text(this.artifact.likes?.toString() || '0')
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Center)
                }
                .width('100%')
                .padding({ top: 16, bottom: 16 })
                .backgroundColor('#F9F9F9')
                .borderRadius(8)
                .margin({ bottom: 8 })

                // åŸºæœ¬ä¿¡æ¯æ 2 - åšç‰©é¦†
                Row() {
                  // åšç‰©é¦†
                  Column() {
                    Text('åšç‰©é¦†')
                      .fontSize(14)
                      .fontColor('#999999')
                    Text(this.artifact.museum || 'æœªçŸ¥')
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .margin({ top: 4 })                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .padding({ top: 12, bottom: 12, left: 16, right: 16 })
                .backgroundColor('#F9F9F9')
                .borderRadius(8)
                .margin({ bottom: 12 })

                // è¯¦ç»†ä»‹ç»æ ‡é¢˜
                Text('è¯¦ç»†ä»‹ç»')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 8, bottom: 8 })
                  .alignSelf(ItemAlign.Start)

                // è¯¦ç»†ä»‹ç»å†…å®¹
                Text(this.artifact.description || 'æš‚æ— ä»‹ç»')
                  .fontSize(16)
                  .fontColor('#333333')
                  .margin({ bottom: 24 })
                  .alignSelf(ItemAlign.Start)

                // è¯„è®ºåŒºæ ‡é¢˜
                Text('è¯„è®ºåŒº')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 8, bottom: 16 })
                  .alignSelf(ItemAlign.Start)

                // è¯„è®ºåˆ—è¡¨
                if (this.isLoadingComments) {
                  // åŠ è½½ä¸­æ˜¾ç¤º
                  Column() {
                    LoadingProgress()
                      .width(30)
                      .height(30)
                    Text('åŠ è½½è¯„è®ºä¸­...')
                      .fontSize(14)
                      .fontColor('#999999')
                      .margin({ top: 8 })
                  }
                  .width('100%')
                  .padding({ top: 20, bottom: 20 })
                  .justifyContent(FlexAlign.Center)
                } else if (this.comments.length === 0) {
                  // æ— è¯„è®ºæ˜¾ç¤º
                  Column() {
                    Text('æš‚æ— è¯„è®º')
                      .fontSize(14)
                      .fontColor('#999999')
                  }
                  .width('100%')
                  .padding({ top: 20, bottom: 20 })
                  .justifyContent(FlexAlign.Center)
                } else {
                  // è¯„è®ºåˆ—è¡¨
                  Column() {
                    ForEach(this.comments, (comment: Comment) => {
                      Column() {
                        // è¯„è®ºè€…å’Œæ—¶é—´
                        Row() {
                          Text(comment.username || 'åŒ¿åç”¨æˆ·')
                            .fontSize(16)
                            .fontWeight(FontWeight.Medium)
                          Text(this.formatDate(comment.publishTime))
                            .fontSize(14)
                            .fontColor('#999999')
                            .margin({ left: 8 })

                          // å®¡æ ¸çŠ¶æ€æ ‡ç­¾ - ä¿®æ”¹ä¸ºæ›´æ˜æ˜¾çš„å¾…å®¡æ ¸æ ‡ç­¾
                          if (comment.userId === this.currentUserId && comment.reviewStatus === 'æœªé€šè¿‡') {
                            Text('å¾…å®¡æ ¸')
                              .fontSize(12)
                              .fontColor('#FFFFFF')
                              .backgroundColor('#FF9800')
                              .borderRadius(4)
                              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                              .margin({ left: 8 })
                          }
                        }
                        .width('100%')
                        .justifyContent(FlexAlign.SpaceBetween)
                        .margin({ bottom: 8 })

                        // è¯„è®ºå†…å®¹
                        Text(comment.content || '')
                          .fontSize(15)
                          .fontColor('#333333')
                          .width('100%')

                        // åˆ é™¤å’Œç¼–è¾‘æŒ‰é’®
                        if (comment.userId === this.currentUserId) {
                          Row() {
                            Button({ type: ButtonType.Normal }) {
                              Text('åˆ é™¤')
                                .fontSize(14)
                                .fontColor('#FF0000')
                            }
                            .height(30)
                            .width(60)
                            .backgroundColor('#FFEEEE')
                            .borderRadius(15)
                            .onClick(() => {
                              this.deleteComment(comment.commentId);
                            })

                            // æ·»åŠ ç¼–è¾‘æŒ‰é’®
                            Button({ type: ButtonType.Normal }) {
                              Text('ç¼–è¾‘')
                                .fontSize(14)
                                .fontColor('#4E86FF')
                            }
                            .height(30)
                            .width(60)
                            .backgroundColor('#E6F0FF')
                            .borderRadius(15)
                            .margin({ left: 8 })
                            .onClick(() => {
                              this.startEditComment(comment);
                            })
                          }
                          .margin({ top: 8 })
                        }
                      }
                      .width('100%')
                      .padding(16)
                      .backgroundColor('#F9F9F9')
                      .borderRadius(8)
                      .margin({ bottom: 12 })
                    })
                  }
                  .width('100%')
                }
              }
              .width('100%')
              .padding({ left: 16, right: 16 })
              .backgroundColor('#FFFFFF')            }
          }
        }
        .width('100%')      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // åº•éƒ¨æ“ä½œæ 
      Row() {
        // è¯„è®ºè¾“å…¥æ¡† - ä¿®æ”¹ä¸ºåŒå‘ç»‘å®š
        TextInput({
          placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...',
          text: this.commentText
        })
          .height(40)
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 16, right: 16 })
          .fontSize(14)
          .onChange((value: string) => {
            this.commentText = value;
          })

        // æ·»åŠ å‘é€æŒ‰é’®
        Button({ type: ButtonType.Normal }) {
          Row() {
            Text('å‘é€')
              .fontSize(14)
              .fontColor('#FFFFFF')
          }
        }
        .height(40)
        .width(60)
        .margin({ left: 8 })
        .backgroundColor('#4E86FF')
        .borderRadius(20)
        .enabled(!this.isSubmittingComment)
        .onClick(() => {
          this.submitComment();
        })

        // ç‚¹èµæŒ‰é’® - æ ¹æ®ç‚¹èµçŠ¶æ€æ˜¾ç¤ºä¸åŒæ ·å¼
        Button({ type: ButtonType.Normal }) {
          Row() {
            // æ ¹æ®ç‚¹èµçŠ¶æ€æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡å’Œé¢œè‰²
            Text(this.isLiked ? 'â¤ï¸' : 'ğŸ‘')
              .fontSize(18)
            Text(this.isLiked ? 'å·²ç‚¹èµ' : 'ç‚¹èµ')
              .fontSize(14)
              .fontColor(this.isLiked ? '#FF4D4F' : '#4E86FF')
              .margin({ left: 4 })
          }
        }
        .height(40)
        .margin({ left: 8 })
        .backgroundColor(this.isLiked ? '#FFEEEE' : '#F0F7FF')
        .borderRadius(20)
        .onClick(() => {
          this.toggleLike();
        })

        // æ”¶è—æŒ‰é’® - æ ¹æ®æ”¶è—çŠ¶æ€æ˜¾ç¤ºä¸åŒæ ·å¼
        Button({ type: ButtonType.Normal }) {
          Row() {
            // ä½¿ç”¨æ–‡å­—è¡¨æƒ…æ›¿ä»£å›¾æ ‡ï¼Œæ ¹æ®æ”¶è—çŠ¶æ€æ˜¾ç¤ºä¸åŒå›¾æ ‡
            Text(this.isCollected ? 'â˜…' : 'â˜†')
              .fontSize(18)
              .fontColor(this.isCollected ? '#FFA500' : '#4E86FF')
            Text(this.isCollected ? 'å·²æ”¶è—' : 'æ”¶è—')
              .fontSize(14)
              .fontColor(this.isCollected ? '#FFA500' : '#4E86FF')
              .margin({ left: 4 })
          }
        }
        .height(40)
        .margin({ left: 8 })
        .backgroundColor(this.isCollected ? '#FFF8E6' : '#F0F7FF')
        .borderRadius(20)
        .onClick(() => {
          this.toggleCollection();
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderColor('#EEEEEE')
      .borderWidth({ top: 1 })

      // æ·»åŠ ç¼–è¾‘è¯„è®ºçš„å¼¹çª—
      if (this.isEditingComment) {
        Column() {
          // å¼¹çª—æ ‡é¢˜
          Text('ç¼–è¾‘è¯„è®º')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 16 })

          // è¯„è®ºç¼–è¾‘æ¡†
          TextArea({
            placeholder: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹',
            text: this.editingCommentText
          })
            .height(120)
            .width('100%')
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .padding(12)
            .fontSize(16)
            .onChange((value: string) => {
              this.editingCommentText = value;
            })

          // æŒ‰é’®è¡Œ
          Row() {
            // å–æ¶ˆæŒ‰é’®
            Button({ type: ButtonType.Normal }) {
              Text('å–æ¶ˆ')
                .fontSize(16)
                .fontColor('#999999')
            }
            .height(40)
            .layoutWeight(1)
            .backgroundColor('#F5F5F5')
            .borderRadius(20)
            .margin({ right: 8 })
            .onClick(() => {
              this.cancelEditComment();
            })

            // ç¡®è®¤æŒ‰é’®
            Button({ type: ButtonType.Normal }) {
              Text('ä¿å­˜')
                .fontSize(16)
                .fontColor('#FFFFFF')
            }
            .height(40)
            .layoutWeight(1)
            .backgroundColor('#4E86FF')
            .borderRadius(20)
            .margin({ left: 8 })
            .onClick(() => {
              this.saveEditedComment();
            })
          }
          .width('100%')
          .margin({ top: 16 })
        }
        .width('90%')
        .padding(24)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .shadow({ radius: 6, color: '#00000020', offsetX: 0, offsetY: 2 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}