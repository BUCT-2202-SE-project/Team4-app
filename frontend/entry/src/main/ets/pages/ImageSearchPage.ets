import router from '@ohos.router';
import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
import fs from '@ohos.file.fs';
import buffer from '@ohos.buffer';
import resourceManager from '@ohos.resourceManager';
import { photoAccessHelper } from '@kit.MediaLibraryKit';
import { image } from '@kit.ImageKit';
import { fileIo } from '@kit.CoreFileKit';
import common from '@ohos.app.ability.common';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import bundleManager from '@ohos.bundle.bundleManager';
import ApiConstants from '../common/constants/ApiConstants';
import prompt from '@ohos.promptAction';

// å®šä¹‰é”™è¯¯å“åº”æ¥å£
interface ErrorResponse {
  message?: string;
  status?: number;
  error?: string;
}

// ç»Ÿä¸€å®šä¹‰æ–‡ç‰©æ¥å£ï¼Œç¡®ä¿å­—æ®µåç§°ä¸€è‡´
interface Artifact {
  artifactId: number;  // ä½¿ç”¨artifactIdä½œä¸ºä¸»é”®
  name: string;
  era: string;
  type: string;
  museum: string;
  description: string;
  imageUrl: string;
  likes: number;
  feature?: string;
  similarity?: number; // ä¿ç•™ç›¸ä¼¼åº¦å­—æ®µ(å›¾åƒæœç´¢ç»“æœç‰¹æœ‰)
  // å…¼å®¹æ€§å­—æ®µï¼Œä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨äº†id
  id?: number;
}

// APIå“åº”æ¥å£
interface ApiResponse {
  success: boolean;
  message?: string;
  data?: Artifact[];
}

// å•ä¸ªæ–‡ç‰©é¡¹ç»„ä»¶ - ä»SearchResults.etsé›†æˆ
@Component
struct ArtifactItem {
    // ä¿®å¤: æ·»åŠ é»˜è®¤å€¼ä»¥è§£å†³åˆå§‹åŒ–é”™è¯¯ï¼Œä½¿ç”¨ç»Ÿä¸€æ¥å£
    private artifact: Artifact = {
      artifactId: 0,
      name: '',
      era: '',
      type: '',
      museum: '',
      description: '',
      imageUrl: '',
      likes: 0
    };

  // ä¿®å¤: æ·»åŠ é»˜è®¤çš„ç©ºå‡½æ•°ä½œä¸ºåˆå§‹å€¼
  private onItemClick: (artifact: Artifact) => void = (artifact: Artifact) => {
    console.info('é»˜è®¤ç‚¹å‡»å¤„ç†å‡½æ•°ï¼Œè¯·æä¾›å®é™…å¤„ç†å‡½æ•°');
  };

  build() {
    Column() {
      Row() {
        Image(this.artifact.imageUrl || '')
          .width(80)
          .height(80)
          .objectFit(ImageFit.Cover)
          .borderRadius(8)
          .backgroundColor('#F0F0F0')

        Column() {
          Text(this.artifact.name || 'æœªçŸ¥åç§°')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(`${this.artifact.era || 'æœªçŸ¥æ—¶ä»£'} Â· ${this.artifact.type || 'æœªçŸ¥ç±»å‹'}`)
            .fontSize(14)
            .fontColor('#666666')
            .margin({top: 4, bottom: 4})

          if (this.artifact.similarity !== undefined) {
            // æ˜¾ç¤ºç›¸ä¼¼åº¦ä¿¡æ¯ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
            // Text(`ç›¸ä¼¼åº¦: ${typeof this.artifact.similarity === 'number' ?
            //   (this.artifact.similarity * 100).toFixed(2) + '%' :
            // this.artifact.similarity}`)
            Text(`ç›¸ä¼¼åº¦: ${typeof this.artifact.similarity === 'number' ?
              (this.artifact.similarity * 100).toFixed(2) + '%' :
              parseFloat(this.artifact.similarity) ?
                (parseFloat(this.artifact.similarity) * 100).toFixed(2) + '%' :
                'N/A'}`)
              .fontSize(14)
              .fontColor('#3366FF')
              .fontWeight(FontWeight.Bold)
              .margin({top: 4})
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        .margin({left: 12})

        Text('>')
          .fontSize(18)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .borderRadius(8)
      .margin({bottom: 8})
      .onClick(() => {
        // æ·»åŠ è°ƒè¯•æ—¥å¿—ä»¥ä¾¿æ’æŸ¥é—®é¢˜ï¼Œä¼˜å…ˆä½¿ç”¨artifactId
        console.info(`ç‚¹å‡»æ–‡ç‰©é¡¹: ${this.artifact.name}, ID: ${this.artifact.artifactId || 'æœªçŸ¥'}, å®Œæ•´å¯¹è±¡: ${JSON.stringify(this.artifact)}`);
        this.onItemClick(this.artifact);
      })
    }
  }
}

@Entry
@Component
struct ImageSearchPage {
  @State isLoading: boolean = false;
  @State searchResults: Artifact[] = [];
  @State errorMsg: string = '';
  @State selectedImage: string = '';
  @State showResults: boolean = false;
  @State previewImage: PixelMap | null = null;
  @State isPreviewReady: boolean = false;
  @State searchButtonDisabled: boolean = true;
  @State permissionGranted: boolean = false; // æ·»åŠ æƒé™çŠ¶æ€
  @State imagePath: string = '';
  @State hasResults: boolean = false;

  // ç¤ºä¾‹å›¾ç‰‡è·¯å¾„ - åªæœ‰ä¸€ä¸ª
  private sampleImagePath: string = 'internal://app/resources/rawfile/sample_artifact.jpg';
  private selectedImageData: buffer.Buffer | null = null;

  private httpRequest = http.createHttp();

  aboutToAppear() {
    // åœ¨é¡µé¢å‡ºç°å‰æ£€æŸ¥æƒé™
    this.checkAndRequestPermissions();
  }

  // ä¿®æ”¹åçš„æƒé™æ£€æŸ¥å’Œè¯·æ±‚æ–¹æ³• - å¢å¼ºé”™è¯¯å¤„ç†
  async checkAndRequestPermissions() {
    try {
      // è·å–åº”ç”¨ç¨‹åºçš„tokenId
      try {
        const bundleInfo = await bundleManager.getBundleInfoForSelf(bundleManager.BundleFlag.GET_BUNDLE_INFO_DEFAULT);
        if (!bundleInfo || !bundleInfo.appInfo) {
          console.error('è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥: bundleInfoæˆ–appInfoä¸ºç©º');
          this.permissionGranted = true; // é»˜è®¤æˆäºˆæƒé™ä»¥å…è®¸åº”ç”¨ç»§ç»­è¿è¡Œ
          return;
        }

        const tokenId = bundleInfo.appInfo.accessTokenId;
        console.info(`æˆåŠŸè·å–åº”ç”¨tokenId: ${tokenId}`);

        // åˆ›å»º AtManager å®ä¾‹
        const atManager = abilityAccessCtrl.createAtManager();

        // éœ€è¦è¯·æ±‚çš„åª’ä½“æƒé™
        const permissionName = 'ohos.permission.READ_MEDIA';

        try {
          // æ£€æŸ¥æƒé™çŠ¶æ€
          const result = await atManager.checkAccessToken(tokenId, permissionName);
          if (result === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
            this.permissionGranted = true;
            console.info('å·²è·å–åª’ä½“æƒé™');
          } else {
            // è¯·æ±‚æƒé™
            const context = getContext(this) as common.UIAbilityContext;
            await atManager.requestPermissionsFromUser(context, [permissionName]);

            // å†æ¬¡æ£€æŸ¥æƒé™æ˜¯å¦è¢«æˆäºˆ
            const checkResult = await atManager.checkAccessToken(tokenId, permissionName);
            if (checkResult === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
              this.permissionGranted = true;
              console.info('ç”¨æˆ·æˆäºˆäº†åª’ä½“æƒé™');
            } else {
              this.permissionGranted = false;
              this.errorMsg = 'æœªè·å–åª’ä½“è®¿é—®æƒé™ï¼Œå¯èƒ½æ— æ³•é€‰æ‹©å›¾ç‰‡';
              console.error('ç”¨æˆ·æ‹’ç»äº†æƒé™è¯·æ±‚');
            }
          }
        } catch (err) {
          console.error(`è¯·æ±‚æƒé™æ—¶å‡ºé”™: ${err instanceof Error ? err.message : JSON.stringify(err)}`);
          // å³ä½¿æƒé™è¯·æ±‚å¤±è´¥ï¼Œä¹Ÿç»§ç»­ä½¿ç”¨åº”ç”¨
          this.permissionGranted = true;
        }
      } catch (bundleError) {
        console.error(`è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥: ${bundleError instanceof Error ? bundleError.message : JSON.stringify(bundleError)}`);
        // åœ¨æ¨¡æ‹Ÿå™¨ä¸Šè·å–åº”ç”¨ä¿¡æ¯å¯èƒ½å¤±è´¥ï¼Œä»ç„¶ç»§ç»­ä½¿ç”¨
        this.permissionGranted = true;
      }
    } catch (error) {
      console.error(`æƒé™æ£€æŸ¥å‘ç”Ÿæœªé¢„æœŸé”™è¯¯: ${error instanceof Error ? error.message : JSON.stringify(error)}`);
      // æƒé™å¤„ç†å¤±è´¥æ—¶ï¼Œå‡è®¾å·²è·å–æƒé™ä»¥é¿å…é˜»å¡ç”¨æˆ·ä½“éªŒ
      this.permissionGranted = true;
    }
  }

  aboutToDisappear() {
    this.httpRequest.destroy();

    // é‡Šæ”¾å›¾ç‰‡èµ„æº
    if (this.previewImage) {
      this.previewImage.release();
      this.previewImage = null;
    }
  }

  // ä½¿ç”¨æ–°çš„PhotoAccessHelper APIé€‰æ‹©å›¾ç‰‡
  async selectImageWithPhotoHelper() {
    try {
      this.isLoading = true;
      this.errorMsg = '';

      // æ¸…ç†æ—§çš„é¢„è§ˆ
      if (this.previewImage) {
        this.previewImage.release();
        this.previewImage = null;
        this.isPreviewReady = false;
      }

      // åˆ›å»ºç…§ç‰‡é€‰æ‹©å™¨
      let picker = new photoAccessHelper.PhotoViewPicker();
      let options: photoAccessHelper.PhotoSelectOptions = {
        MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      };

      console.info('æ‰“å¼€å›¾ç‰‡é€‰æ‹©å™¨...');
      promptAction.showToast({ message: 'è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡' });

      // é€‰æ‹©å›¾ç‰‡
      try {
        const photoResult = await picker.select(options);

        if (photoResult && photoResult.photoUris && photoResult.photoUris.length > 0) {
          const photoUri = photoResult.photoUris[0];
          console.info(`é€‰æ‹©äº†å›¾ç‰‡: ${photoUri}`);

          // æ˜¾ç¤ºå¤„ç†æç¤º
          promptAction.showToast({
            message: 'æ­£åœ¨å¤„ç†å›¾ç‰‡...',
            duration: 2000
          });

          // æ‰“å¼€æ–‡ä»¶
          const file = fileIo.openSync(photoUri);

          // åˆ›å»ºå›¾åƒæº
          const imgSource = image.createImageSource(file.fd);
          if (!imgSource) {
            throw new Error("æ— æ³•ä»æ–‡ä»¶åˆ›å»ºå›¾åƒæº");
          }

          // è·å–å›¾åƒä¿¡æ¯
          const imageInfo = await imgSource.getImageInfo();
          console.info(`å›¾åƒä¿¡æ¯: å®½=${imageInfo.size.width}, é«˜=${imageInfo.size.height}`);

          // ç¼©å°å›¾åƒå°ºå¯¸
          const maxDimension = 800;
          let targetWidth = imageInfo.size.width;
          let targetHeight = imageInfo.size.height;

          if (targetWidth > maxDimension || targetHeight > maxDimension) {
            if (targetWidth > targetHeight) {
              targetHeight = Math.floor(targetHeight * (maxDimension / targetWidth));
              targetWidth = maxDimension;
            } else {
              targetWidth = Math.floor(targetWidth * (maxDimension / targetHeight));
              targetHeight = maxDimension;
            }
          }

          // åˆ›å»ºè§£ç é€‰é¡¹
          const decodingOptions: image.DecodingOptions = {
            desiredSize: { width: targetWidth, height: targetHeight },
            editable: true,
            desiredPixelFormat: image.PixelMapFormat.RGBA_8888
          };

          // åˆ›å»ºåƒç´ å›¾
          this.previewImage = await imgSource.createPixelMap(decodingOptions);

          // é‡Šæ”¾èµ„æº
          imgSource.release();
          fileIo.closeSync(file.fd);

          if (!this.previewImage) {
            throw new Error("åˆ›å»ºåƒç´ å›¾å¤±è´¥");
          }

          // è·å–å›¾åƒæ•°æ®
          const imagePackerApi = image.createImagePacker();

          // ä½¿ç”¨æ ‡å‡†JPEGæ ¼å¼å’Œé«˜è´¨é‡
          const packOptions: image.PackingOption = {
            format: 'image/jpeg',
            quality: 95
          };

          const imageData = await imagePackerApi.packing(this.previewImage, packOptions);
          imagePackerApi.release();

          if (!imageData || imageData.byteLength === 0) {
            throw new Error("æ— æ³•è·å–å›¾åƒæ•°æ®");
          }

          // ä½¿ç”¨Bufferå­˜å‚¨æ•°æ®
          this.selectedImageData = buffer.from(imageData);
          this.selectedImage = photoUri;
          this.searchButtonDisabled = false;
          this.isPreviewReady = true;

          console.info(`å›¾åƒå¤„ç†æˆåŠŸå®Œæˆï¼Œæ•°æ®å¤§å°: ${this.selectedImageData.length} å­—èŠ‚`);
          promptAction.showToast({ message: 'å›¾ç‰‡å‡†å¤‡å®Œæˆ' });
        } else {
          console.info('ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©');
          promptAction.showToast({ message: 'æœªé€‰æ‹©å›¾ç‰‡' });
        }
      } catch (err) {
        console.error(`é€‰æ‹©å›¾ç‰‡å¤±è´¥: ${JSON.stringify(err)}`);
        this.errorMsg = `é€‰æ‹©å›¾ç‰‡å¤±è´¥: ${err instanceof Error ? err.message : String(err)}`;
        promptAction.showToast({ message: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡' });
        await this.useSampleImage();
      }
    } catch (finalError) {
      console.error(`å›¾ç‰‡é€‰æ‹©è¿‡ç¨‹å‡ºç°ä¸¥é‡é”™è¯¯: ${JSON.stringify(finalError)}`);
      this.errorMsg = `é€‰æ‹©å›¾ç‰‡å¤±è´¥: ${finalError instanceof Error ? finalError.message : String(finalError)}`;
      promptAction.showToast({ message: 'å›¾ç‰‡é€‰æ‹©å¤±è´¥', duration: 3000 });
    } finally {
      this.isLoading = false;
    }
  }

  // æ–°å¢æ–¹æ³•ï¼šå¤„ç†é€‰æ‹©çš„å›¾ç‰‡ - ä¿®å¤ç±»å‹é”™è¯¯
  async processSelectedImage(photoUri: string): Promise<void> {
    try {
      // è®°å½•æ›´å¤šä¿¡æ¯ä»¥ä¾¿è°ƒè¯•
      console.info(`å¤„ç†å›¾ç‰‡URI: ${photoUri}`);

      // æ–¹æ³•1: å°è¯•ä½¿ç”¨ç›´æ¥åˆ›å»ºå›¾åƒæº
      try {
        console.info("å°è¯•æ–¹æ³•1: ç›´æ¥åˆ›å»ºå›¾åƒæº");

        // åˆ›å»ºå›¾åƒæº - ä¿®æ”¹å£°æ˜æ–¹å¼
        const imgSource = image.createImageSource(photoUri);
        if (!imgSource) {
          throw new Error("åˆ›å»ºå›¾åƒæºå¤±è´¥ï¼Œè¿”å›null");
        }

        // è·å–å›¾åƒä¿¡æ¯
        const imageInfo = await imgSource.getImageInfo();
        console.info(`å›¾åƒä¿¡æ¯: ${JSON.stringify(imageInfo)}`);

        // å¦‚æœå›¾åƒå¤ªå¤§ï¼Œè®¾ç½®åˆç†çš„è§£ç å¤§å°
        const maxSize = 1024;
        let targetWidth = imageInfo.size.width;
        let targetHeight = imageInfo.size.height;

        if (targetWidth > maxSize || targetHeight > maxSize) {
          if (targetWidth > targetHeight) {
            targetHeight = Math.floor(targetHeight * (maxSize / targetWidth));
            targetWidth = maxSize;
          } else {
            targetWidth = Math.floor(targetWidth * (maxSize / targetHeight));
            targetHeight = maxSize;
          }
        }

        // åˆ›å»ºè§£ç é€‰é¡¹
        const decodingOptions: image.DecodingOptions = {
          desiredSize: {
            width: targetWidth,
            height: targetHeight
          },
          desiredPixelFormat: image.PixelMapFormat.RGBA_8888
        };

        console.info(`è®¾ç½®è§£ç å°ºå¯¸: ${targetWidth}x${targetHeight}`);

        // åˆ›å»ºåƒç´ å›¾
        this.previewImage = await imgSource.createPixelMap(decodingOptions);

        if (!this.previewImage) {
          throw new Error("åˆ›å»ºåƒç´ å›¾è¿”å›null");
        }

        // é‡Šæ”¾å›¾åƒæº
        imgSource.release();

        this.isPreviewReady = true;
        this.selectedImage = photoUri;

        // è·å–å›¾åƒæ•°æ®
        const imageData = await this.getPixelMapData(this.previewImage);

        if (!imageData || imageData.byteLength === 0) {
          throw new Error("è·å–å›¾åƒæ•°æ®å¤±è´¥ï¼Œå¤§å°ä¸º0");
        }

        this.selectedImageData = buffer.from(imageData);

        console.info(`æˆåŠŸå¤„ç†å›¾ç‰‡ï¼Œå¤§å°: ${this.selectedImageData.length} å­—èŠ‚`);
        this.searchButtonDisabled = false;

        promptAction.showToast({ message: 'å›¾ç‰‡åŠ è½½æˆåŠŸ' });
        return;
      } catch (err) {
        console.error(`æ–¹æ³•1å¤±è´¥: ${err instanceof Error ? err.message : String(err)}`);

        // ç›´æ¥ä½¿ç”¨å¤‡ç”¨å›¾åƒä»£æ›¿
        console.info("ä½¿ç”¨å¤‡ç”¨å›¾åƒ");
        await this.createBackupImage();

        this.selectedImage = 'backup_image.jpg';
        this.searchButtonDisabled = false;

        promptAction.showToast({
          message: 'å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å›¾åƒ',
          duration: 3000
        });
      }
    } catch (finalError) {
      console.error(`å›¾ç‰‡å¤„ç†æœ€ç»ˆå¤±è´¥: ${finalError instanceof Error ? finalError.message : String(finalError)}`);
      this.errorMsg = `æ— æ³•å¤„ç†é€‰ä¸­çš„å›¾ç‰‡: ${finalError instanceof Error ? finalError.message : 'æœªçŸ¥é”™è¯¯'}`;
      promptAction.showToast({ message: 'å›¾ç‰‡å¤„ç†å¤±è´¥' });

      // ä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡ä½œä¸ºæœ€åçš„åå¤‡é€‰æ‹©
      await this.useSampleImage();
    }
  }

  // åˆ›å»ºå¤‡ç”¨å›¾åƒ - å¢å¼ºç‰ˆï¼Œç¡®ä¿å¯ä»¥é¢„è§ˆ
  async createBackupImage(): Promise<boolean> {
    console.info("åˆ›å»ºå¤‡ç”¨å›¾åƒ");

    // æ¸…ç†æ—§çš„é¢„è§ˆå›¾ç‰‡
    if (this.previewImage) {
      this.previewImage.release();
      this.previewImage = null;
    }

    // åˆ›å»ºå½©è‰²æ¸å˜å›¾åƒ
    const width = 256;
    const height = 256;
    const mockImageSize = width * height * 4; // RGBAæ ¼å¼
    const mockImageData = new ArrayBuffer(mockImageSize);
    const dataView = new Uint8Array(mockImageData);

    // ä½¿ç”¨æ›´é²œæ˜çš„æ©™è‰²æ¸å˜ï¼Œæ¥è¿‘åšç‰©é¦†æ–‡ç‰©è‰²è°ƒ
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const pos = (y * width + x) * 4;
        dataView[pos] = Math.min(255, 180 + Math.floor(y / height * 75)); // R
        dataView[pos + 1] = Math.min(255, 100 + Math.floor(x / width * 55)); // G
        dataView[pos + 2] = 50; // B ä½è“è‰²
        dataView[pos + 3] = 255; // Alpha
      }
    }

    // æ·»åŠ ä¸€ä¸ªæ–‡ç‰©å½¢çŠ¶
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 3;

    // ç»˜åˆ¶èŠ±ç“¶å½¢çŠ¶
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        // è®¡ç®—ç›¸å¯¹äºä¸­å¿ƒçš„ä½ç½®
        const normalizedX = (x - centerX) / radius;
        const normalizedY = (y - centerY) / radius;

        // èŠ±ç“¶å½¢çŠ¶
        const vaseShape = Math.abs(normalizedX) * 2 <
          (0.5 + 0.5 * Math.sin(normalizedY * 3)) &&
          normalizedY > -1.2 && normalizedY < 1.2;

        if (vaseShape) {
          const pos = (y * width + x) * 4;
          dataView[pos] = 220;     // é™¶å™¨çº¢è‰²
          dataView[pos + 1] = 200; // G
          dataView[pos + 2] = 180; // B
        }
      }
    }

    // ä¿å­˜æ•°æ®
    this.selectedImageData = buffer.from(mockImageData);
    this.selectedImage = 'backup_image.jpg';

    try {
      // åˆ›å»ºé¢„è§ˆå›¾åƒ
      const imageSource = image.createImageSource(this.selectedImageData.buffer);
      if (!imageSource) {
        throw new Error("åˆ›å»ºå›¾åƒæºå¤±è´¥");
      }

      // ä½¿ç”¨é»˜è®¤é€‰é¡¹åˆ›å»ºPixelMap
      this.previewImage = await imageSource.createPixelMap();
      imageSource.release();

      if (this.previewImage) {
        // ä½¿ç”¨setTimeoutå¼ºåˆ¶æ›´æ–°UIçŠ¶æ€
        setTimeout(() => {
          this.isPreviewReady = true;
          console.info('å¤‡ç”¨å›¾åƒé¢„è§ˆæ ‡å¿—è®¾ç½®ä¸ºtrue');
        }, 100);

        this.searchButtonDisabled = false;
        console.info('å¤‡ç”¨å›¾åƒé¢„è§ˆåˆ›å»ºæˆåŠŸ');

        return true;
      } else {
        throw new Error("åˆ›å»ºå¤‡ç”¨å›¾åƒé¢„è§ˆå¤±è´¥");
      }
    } catch (err) {
      console.error(`åˆ›å»ºå¤‡ç”¨å›¾åƒé¢„è§ˆå¤±è´¥: ${err}`);
      this.isPreviewReady = false;
      this.previewImage = null;
      return false;
    }
  }

  // ä½¿ç”¨é¡¹ç›®ä¸­çœŸå®çš„JPEGæ ·æœ¬å›¾ç‰‡
  async useSampleImage() {
    try {
      this.isLoading = true;
      this.errorMsg = '';
      this.showResults = false;

      // æ¸…ç†æ—§çš„é¢„è§ˆå›¾ç‰‡
      if (this.previewImage) {
        this.previewImage.release();
        this.previewImage = null;
      }

      console.info('åŠ è½½é¡¹ç›®ä¸­çš„æ ·æœ¬JPEGå›¾ç‰‡');

      // ä½¿ç”¨ç›¸å¯¹è·¯å¾„æŒ‡å‘rawfileæ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡
      const samplePath = 'resource://rawfile/sample_artifact.jpg';

      try {
        // ä½¿ç”¨resourceManageråŠ è½½å›¾ç‰‡
        const context = getContext(this) as common.UIAbilityContext;
        const resourceMgr = context.resourceManager;

        console.info(`å°è¯•åŠ è½½èµ„æº: ${samplePath}`);

        // ä»èµ„æºæ–‡ä»¶åŠ è½½å›¾ç‰‡
        const imageData = await resourceMgr.getRawFileContent(samplePath);
        console.info(`æˆåŠŸåŠ è½½æ ·æœ¬å›¾ç‰‡, å¤§å°: ${imageData.byteLength} å­—èŠ‚`);

        // æ£€æŸ¥JPEGå¤´éƒ¨æ ‡è¯†
        const dataView = new Uint8Array(imageData);
        if (dataView[0] === 0xFF && dataView[1] === 0xD8) {
          console.info('éªŒè¯æˆåŠŸ: æ­£ç¡®çš„JPEGå¤´éƒ¨');
        } else {
          console.warn(`è­¦å‘Š: æ ·æœ¬å›¾åƒå¯èƒ½ä¸æ˜¯æ ‡å‡†JPEGæ ¼å¼! å¤´éƒ¨: ${dataView[0].toString(16)} ${dataView[1].toString(16)}`);
        }

        // æ‰“å°å¤´éƒ¨åå…­è¿›åˆ¶å€¼è¿›è¡Œè°ƒè¯•
        let hexPrefix = '';
        for (let i = 0; i < Math.min(16, dataView.length); i++) {
          hexPrefix += ` ${dataView[i].toString(16).padStart(2, '0')}`;
        }
        console.info(`å›¾åƒæ•°æ®å¤´éƒ¨(åå…­è¿›åˆ¶):${hexPrefix}`);

        // åˆ›å»ºBuffer
        this.selectedImageData = buffer.from(imageData);
        this.selectedImage = 'sample_artifact.jpg';

        // åˆ›å»ºå›¾åƒæºä¾›é¢„è§ˆ
        try {
          const imageSource = image.createImageSource(imageData);
          if (!imageSource) {
            throw new Error('æ— æ³•åˆ›å»ºå›¾åƒæº');
          }

          // åˆ›å»ºåƒç´ å›¾
          this.previewImage = await imageSource.createPixelMap();
          imageSource.release();

          if (this.previewImage) {
            this.isPreviewReady = true;
            console.info('é¢„è§ˆå›¾åƒåˆ›å»ºæˆåŠŸ');

            // è·å–é¢„è§ˆå›¾åƒä¿¡æ¯
            const imageInfo = await this.previewImage.getImageInfo();
            console.info(`é¢„è§ˆå›¾åƒå°ºå¯¸: ${imageInfo.size.width}x${imageInfo.size.height}`);
          }
        } catch (previewError) {
          console.error(`é¢„è§ˆåˆ›å»ºå¤±è´¥: ${JSON.stringify(previewError)}`);
          this.isPreviewReady = false;
        }

        // å…è®¸æœç´¢
        this.searchButtonDisabled = false;
        promptAction.showToast({ message: 'å·²åŠ è½½ç¤ºä¾‹å›¾ç‰‡' });

      } catch (resourceError) {
        console.error(`åŠ è½½èµ„æºå¤±è´¥: ${JSON.stringify(resourceError)}`);

        // å°è¯•ä½¿ç”¨ç»å¯¹è·¯å¾„
        console.info('å°è¯•ä½¿ç”¨ç»å¯¹è·¯å¾„åŠ è½½å›¾ç‰‡');
        const absolutePath = 'D:/collegelife/Grade_three_second/SWE/frontend/entry/src/main/resources/rawfile/sample_artifact.jpg';

        try {
          // ä½¿ç”¨æ–‡ä»¶IO APIè¯»å–å›¾ç‰‡ - ä¿®å¤è¿”å›å€¼ç±»å‹é—®é¢˜
          const file = await fs.open(absolutePath, fs.OpenMode.READ_ONLY);
          const fileInfo = await fs.stat(absolutePath);

          // åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜æ”¾è¯»å–çš„æ•°æ®
          const imageBuffer = new ArrayBuffer(fileInfo.size);

          // è¯»å–æ•°æ®åˆ°ç¼“å†²åŒºä¸­ï¼Œreadè¿”å›çš„æ˜¯è¯»å–çš„å­—èŠ‚æ•°
          const bytesRead = await fs.read(file.fd, imageBuffer);
          await fs.close(file.fd);

          console.info(`æˆåŠŸè¯»å–æ ·æœ¬å›¾ç‰‡, å¤§å°: ${imageBuffer.byteLength} å­—èŠ‚ï¼Œå®é™…è¯»å–: ${bytesRead} å­—èŠ‚`);

          // æ£€æŸ¥å¤´éƒ¨
          const dataView = new Uint8Array(imageBuffer);
          if (dataView[0] === 0xFF && dataView[1] === 0xD8) {
            console.info('éªŒè¯æˆåŠŸ: æ­£ç¡®çš„JPEGå¤´éƒ¨');
          }

          // åˆ›å»ºBuffer
          this.selectedImageData = buffer.from(imageBuffer);
          this.selectedImage = 'sample_artifact.jpg';
          this.searchButtonDisabled = false;

        } catch (fileError) {
          console.error(`æ–‡ä»¶è¯»å–å¤±è´¥: ${JSON.stringify(fileError)}`);
          throw new Error('æ— æ³•åŠ è½½æ ·æœ¬å›¾ç‰‡');
        }
      }

    } catch (finalError) {
      console.error(`æ ·æœ¬å›¾ç‰‡åŠ è½½å¤±è´¥: ${JSON.stringify(finalError)}`);
      this.errorMsg = 'åŠ è½½æ ·æœ¬å›¾ç‰‡å¤±è´¥';
      this.searchButtonDisabled = true;
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ›å»ºå›¾åƒé¢„è§ˆ
  async createImagePreview(imageData: buffer.Buffer) {
    try {
      // é‡Šæ”¾æ—§çš„é¢„è§ˆå›¾ç‰‡
      if (this.previewImage) {
        this.previewImage.release();
        this.previewImage = null;
      }

      // åˆ›å»ºå›¾åƒæº
      const imageSource = image.createImageSource(imageData.buffer);
      if (!imageSource) {
        throw new Error('åˆ›å»ºå›¾åƒæºå¤±è´¥');
      }

      console.info('æˆåŠŸåˆ›å»ºå›¾åƒæºï¼Œå‡†å¤‡ç”Ÿæˆé¢„è§ˆ...');

      // è®¾ç½®è§£ç é€‰é¡¹ - æ·»åŠ æ˜ç¡®çš„ç±»å‹ï¼Œæ›´åˆé€‚çš„å°ºå¯¸
      const decodingOptions: image.DecodingOptions = {
        desiredSize: { width: 400, height: 400 }, // å‡å°å°ºå¯¸ï¼Œæé«˜æ€§èƒ½
        desiredPixelFormat: image.PixelMapFormat.RGBA_8888 // æ˜ç¡®è®¾ç½®åƒç´ æ ¼å¼
      };

      // åˆ›å»ºåƒç´ å›¾
      this.previewImage = await imageSource.createPixelMap(decodingOptions);

      // é‡Šæ”¾å›¾åƒæº
      imageSource.release();

      if (!this.previewImage) {
        throw new Error('åˆ›å»ºé¢„è§ˆå›¾åƒå¤±è´¥ï¼Œç»“æœä¸ºnull');
      }

      // ç›´æ¥æ£€æŸ¥å›¾åƒå°ºå¯¸ï¼Œç¡®è®¤é¢„è§ˆæœ‰æ•ˆ
      const imageInfo = await this.previewImage.getImageInfo();
      console.info(`é¢„è§ˆå›¾åƒåˆ›å»ºæˆåŠŸï¼Œå°ºå¯¸: ${imageInfo.size.width}x${imageInfo.size.height}`);

      this.isPreviewReady = true;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      console.error(`åˆ›å»ºå›¾åƒé¢„è§ˆå¤±è´¥: ${errorMsg}`);
      this.isPreviewReady = false;
      this.previewImage = null;
    }
  }

  // ä»PixelMapè·å–å›¾åƒæ•°æ®
  async getPixelMapData(pixelMap: image.PixelMap): Promise<ArrayBuffer> {
    return new Promise<ArrayBuffer>((resolve, reject) => {
      try {
        // åˆ›å»ºå›¾ç‰‡åŒ…è£…å™¨å®ä¾‹
        const imagePackerApi = image.createImagePacker();

        // æ‰“åŒ…å‚æ•° - æ·»åŠ æ˜ç¡®çš„ç±»å‹å¹¶é™ä½è´¨é‡ä»¥å‡å°å¤§å°
        const packOptions: image.PackingOption = {
          format: 'image/jpeg',
          quality: 80 // é™ä½è´¨é‡ï¼Œç¡®ä¿æ•°æ®å¤§å°åˆç†
        };

        // æ‰“åŒ…å›¾åƒ
        imagePackerApi.packing(pixelMap, packOptions)
          .then((data: ArrayBuffer) => {
            // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
            if (!data || data.byteLength === 0) {
              imagePackerApi.release();
              reject(new Error("æ‰“åŒ…å›¾åƒè¿”å›ç©ºæ•°æ®"));
              return;
            }

            // é‡Šæ”¾èµ„æº
            imagePackerApi.release();
            resolve(data);
          })
          .catch((err: Error) => {
            // é‡Šæ”¾èµ„æº
            imagePackerApi.release();
            reject(err);
          });
      } catch (error) {
        reject(error instanceof Error ? error : new Error(String(error)));
      }
    });
  }

  // å¼€å§‹å›¾åƒæœç´¢
  async startImageSearch() {
    if (!this.selectedImageData || this.searchButtonDisabled) {
      promptAction.showToast({ message: 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡' });
      return;
    }

    try {
      this.isLoading = true;
      this.errorMsg = '';
      this.showResults = false;

      // å‘é€å›¾ç‰‡æ•°æ®åˆ°åç«¯
      await this.sendImageToBackend(this.selectedImageData);
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      this.errorMsg = `å›¾ç‰‡å¤„ç†å¤±è´¥: ${errorMsg}`;
      console.error(`å›¾åƒæœç´¢å¤±è´¥: ${errorMsg}`);
    } finally {
      this.isLoading = false;
    }
  }

  // å‘é€å›¾ç‰‡åˆ°åç«¯è¿›è¡Œä»¥å›¾æœå›¾ - ä¿®æ”¹ä¸ºæ”¯æŒä»»ä½•å›¾åƒæ ¼å¼
  async sendImageToBackend(imageData: buffer.Buffer) {
    try {
      const url = ApiConstants.getFullUrl(ApiConstants.API_IMAGE_SEARCH);
      console.info(`å‡†å¤‡å‘é€å›¾åƒæœç´¢è¯·æ±‚:`);
      console.info(`- URL: ${url}`);
      console.info(`- å›¾ç‰‡æ•°æ®å¤§å°: ${imageData.length} å­—èŠ‚`);
      console.info(`- Content-Type: image/jpeg`); 

      // è®¾ç½®è¯·æ±‚é€‰é¡¹
      const requestOptions: http.HttpRequestOptions = {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'image/jpeg',
          'Accept': 'application/json'
        },
        extraData: imageData.buffer,
        connectTimeout: 30000,
        readTimeout: 30000
      };

      console.info('å‘é€HTTPè¯·æ±‚ä¸­...');
      const response = await this.httpRequest.request(url, requestOptions);
      console.info(`æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç : ${response.responseCode}`);

      // å¤„ç†å“åº”
      if (response.responseCode === 200) {
        const resultStr = response.result ? response.result.toString() : '{}';
        console.info(`å®Œæ•´å“åº”æ•°æ®: ${resultStr}`); // è®°å½•å®Œæ•´å“åº”ä»¥ä¾¿è°ƒè¯•

        try {
          const result: ApiResponse = JSON.parse(resultStr);

          if (result.success && Array.isArray(result.data)) {
            console.info(`æˆåŠŸè§£ææœç´¢ç»“æœï¼Œæ•°æ®é•¿åº¦: ${result.data.length}`);
            
            // ç¡®ä¿æ¸…é™¤æ—§çš„ç»“æœ
            this.searchResults = [];

            // è®¾ç½®æ–°çš„æœç´¢ç»“æœ
            this.searchResults = result.data;
            
            // ç¡®ä¿æ˜¾ç¤ºç»“æœæ ‡å¿—è¢«è®¾ç½®
            this.showResults = true;
            this.hasResults = this.searchResults.length > 0;
            
            console.info(`æœç´¢è¿”å›äº† ${this.searchResults.length} ä¸ªç»“æœï¼Œç»“æœå°†æ˜¾ç¤º: ${this.showResults}`);
            
            // å¼ºåˆ¶UIæ›´æ–°
            this.isLoading = false;
            
            // å‘ŠçŸ¥ç”¨æˆ·æœç´¢å®Œæˆ
            promptAction.showToast({ 
              message: `æ‰¾åˆ° ${this.searchResults.length} ä¸ªç›¸ä¼¼æ–‡ç‰©`, 
              duration: 3000 
            });
          } else {
            this.errorMsg = result.message || 'æœç´¢æœªè¿”å›æœ‰æ•ˆç»“æœ';
            console.error(`æœç´¢å¤±è´¥: ${this.errorMsg}`);
            this.showResults = false;
            promptAction.showToast({ message: 'æœç´¢ç»“æœä¸ºç©º', duration: 3000 });
          }
        } catch (parseError) {
          console.error(`è§£æå“åº”æ•°æ®å¤±è´¥: ${parseError instanceof Error ? parseError.message : String(parseError)}`);
          console.error(`åŸå§‹å“åº”æ•°æ®: ${resultStr.substring(0, 100)}...`);
          this.errorMsg = 'è§£ææœç´¢ç»“æœå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯è¿”å›æ ¼å¼';
          this.showResults = false;
        }
      } else {
        this.errorMsg = `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.responseCode}`;
        console.error(this.errorMsg);
        this.showResults = false;

        if (response.result) {
          try {
            const errorStr = response.result.toString();
            console.error(`é”™è¯¯è¯¦æƒ…: ${errorStr}`);

            const errorObj: ErrorResponse = JSON.parse(errorStr);
            if (errorObj.message) {
              this.errorMsg += `\n${errorObj.message}`;
            }
          } catch (e) {
            // è§£æé”™è¯¯å“åº”å¤±è´¥ï¼Œå¿½ç•¥
          }
        }
      }
    } catch (error) { 
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      this.errorMsg = `è¯·æ±‚è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${errorMsg}`;
      console.error(`HTTPè¯·æ±‚å¤±è´¥: ${errorMsg}`);
      this.showResults = false;
    }
  }

  // æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦å¯ç”¨
  async checkApiEndpoint() {
    try {
      const url = ApiConstants.getFullUrl(ApiConstants.API_HEALTH_CHECK);
      console.info(`æ£€æŸ¥APIå¥åº·çŠ¶æ€: ${url}`);

      // æ˜¾ç¤ºæ­£åœ¨è¿æ¥çš„URLï¼Œå¸®åŠ©è°ƒè¯•
      promptAction.showToast({ message: `æ­£åœ¨è¿æ¥: ${url}` });

      const response: http.HttpResponse = await this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: { 'Accept': 'application/json' },
          connectTimeout: 5000,
          readTimeout: 5000
        }
      );

      if (response.responseCode >= 200 && response.responseCode < 300) {
        promptAction.showToast({ message: 'APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸' });
        return true;
      } else {
        promptAction.showToast({ message: `APIæœåŠ¡å™¨è¿”å›å¼‚å¸¸çŠ¶æ€: ${response.responseCode}` });
        return false;
      }
    } catch (error) { // æ·»åŠ æ˜ç¡®ç±»å‹
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error(`APIå¥åº·æ£€æŸ¥å¤±è´¥: ${errorMsg}`);

      // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
      promptAction.showToast({
        message: `è¿æ¥å¤±è´¥: ${errorMsg.substring(0, 50)}...`,
        duration: 5000
      });
      return false;
    }
  }


  navigateToDetail(artifact: Artifact) {
    // æ‰“å°å®Œæ•´å¯¹è±¡ï¼Œç”¨äºè°ƒè¯•
    console.info(`å‡†å¤‡è·³è½¬è¯¦æƒ…ï¼ŒåŸå§‹æ–‡ç‰©å¯¹è±¡: ${JSON.stringify(artifact)}`);

    // ç¡®ä¿ä½¿ç”¨idä½œä¸ºä¸»é”®
    const id = artifact.id;

    if (id !== undefined) {
      console.info(`å‡†å¤‡è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œæ–‡ç‰©ID: ${id}`);

      // ä¼ é€’idå’Œå®Œæ•´å¯¹è±¡ï¼Œç¡®ä¿å‚æ•°åç§°ä¸€è‡´
      router.push({
        url: 'pages/ArtifactDetailPage',
        params: {
          id: id,
          artifactId: id, // åŒæ—¶æä¾›idå’ŒartifactIdï¼Œç¡®ä¿ä¸ä¹‹å‰ç‰ˆæœ¬å…¼å®¹
          artifact: artifact
        }
      });
      console.info(`æˆåŠŸè·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œæ–‡ç‰©ID: ${id}`);
    } else {
      console.error('æ–‡ç‰©IDä¸ºç©ºï¼Œæ— æ³•è·³è½¬åˆ°è¯¦æƒ…é¡µ:', JSON.stringify(artifact));
      promptAction.showToast({
        message: 'æ— æ³•æŸ¥çœ‹è¯¦æƒ…ï¼šæ–‡ç‰©IDä¸å­˜åœ¨',
        duration: 2000
      });
    }
  }


  // åœ¨UIæ„å»ºå‡½æ•°ä¸­æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Normal }) {
          Text('â†')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
        }
        .height(40)
        .width(40)
        .backgroundColor('transparent')
        .onClick(() => {
          router.back();
        })

        Text('ä»¥å›¾æœå›¾')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(56)
      .padding({left: 16, right: 16})
      .backgroundColor('#FFFFFF')

      // ä¸»å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // è¯´æ˜æ–‡æœ¬
          Text('ä»¥å›¾æœå›¾ - æŸ¥æ‰¾ç›¸ä¼¼æ–‡ç‰©')
            .fontSize(16)
            .margin({top: 20, bottom: 16})
            .textAlign(TextAlign.Center)

          // å›¾ç‰‡é€‰æ‹©åŒºåŸŸ
          Column() {
            Text('é€‰æ‹©å›¾ç‰‡')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .alignSelf(ItemAlign.Start)
              .margin({bottom: 12})

            // å›¾ç‰‡æ“ä½œæŒ‰é’®
            Row() {
              Button({ type: ButtonType.Normal }) {
                Row() {
                  Text('ä¸Šä¼ æœ¬åœ°å›¾ç‰‡')
                    .fontSize(14)
                    .fontColor('#FFFFFF')
                }
              }
              .height(40)
              .backgroundColor('#3366FF')
              .borderRadius(20)
              .layoutWeight(1)
              .onClick(() => {
                this.selectImageWithPhotoHelper();
              })

                                          /* æ³¨é‡Šæ‰ç¤ºä¾‹å›¾ç‰‡æŒ‰é’®              Button({ type: ButtonType.Normal }) {                Row() {                  Text('ä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡')                    .fontSize(14)                    .fontColor('#FFFFFF')                }              }              .height(40)              .margin({ left: 12 })              .backgroundColor('#4CAF50')              .borderRadius(20)              .layoutWeight(1)              .onClick(() => {                this.useSampleImage();              })              */
            }
            .width('100%')
            .margin({ bottom: 16 })

            // æ”¹è¿›çš„å›¾ç‰‡é¢„è§ˆåŒºåŸŸ - æ·»åŠ è°ƒè¯•ä¿¡æ¯
            Column() {
              // æ·»åŠ è°ƒè¯•ä¿¡æ¯
              Text(`é¢„è§ˆçŠ¶æ€: ${this.isPreviewReady ? "å‡†å¤‡å¥½" : "æœªå‡†å¤‡"}, å›¾åƒå¯¹è±¡: ${this.previewImage ? "å·²åˆ›å»º" : "æœªåˆ›å»º"}`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ bottom: 8 })

              if (this.isPreviewReady && this.previewImage) {
                Text('é¢„è§ˆå›¾ç‰‡')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ bottom: 8 })

                // æ”¹è¿›çš„å›¾ç‰‡æ˜¾ç¤º
                Stack({ alignContent: Alignment.Center }) {
                  // èƒŒæ™¯
                  Column()
                    .width('100%')
                    .height('100%')
                    .aspectRatio(1)
                    .backgroundColor('#EEEEEE')

                  // è¾¹æ¡†æ ‡è®°ï¼Œç¡®ä¿å®¹å™¨æ˜¾ç¤º
                  Column()
                    .width('99%')
                    .height('99%')
                    .borderWidth(2)
                    .borderColor('#FF9800')

                  // å›¾ç‰‡ - ä½¿ç”¨é«˜å¯¹æ¯”åº¦èƒŒæ™¯
                  Column() {
                    Image(this.previewImage)
                      .width('90%')
                      .height('90%')
                      .objectFit(ImageFit.Cover)
                      .backgroundColor('#333333')
                      .borderRadius(4)
                      .onComplete(() => {
                        console.info('å›¾ç‰‡æ¸²æŸ“å®Œæˆ');
                      })
                      .onError(() => {
                        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                        this.errorMsg = 'å›¾ç‰‡é¢„è§ˆåŠ è½½å¤±è´¥';
                      })
                  }
                  .width('95%')
                  .height('95%')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .backgroundColor('#DDDDDD')
                }
                .width('100%')
                .aspectRatio(1)
                .margin({ bottom: 16 })
              } else if (this.isLoading) {
                LoadingProgress()
                  .width(50)
                  .height(50)
                  .color('#3366FF')
                  .margin({ top: 30, bottom: 30 })
              } else {
                Text('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡')
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ top: 40, bottom: 40 })
              }
            }
            .width('100%')
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .padding(16)
            .alignItems(HorizontalAlign.Center)

            // æœç´¢æŒ‰é’®
            Button('å¼€å§‹æœç´¢')
              .width('100%')
              .height(44)
              .margin({ top: 16 })
              .backgroundColor(this.searchButtonDisabled ? '#CCCCCC' : '#FF9800')
              .borderRadius(22)
              .enabled(!this.searchButtonDisabled)
              .onClick(() => {
                this.startImageSearch();
              })

          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({bottom: 16})

          // åŠ è½½çŠ¶æ€æˆ–é”™è¯¯æç¤º
          if (this.isLoading) {
            Row() {
              LoadingProgress()
                .width(24)
                .height(24)
                .color('#3366FF')

              Text('æœç´¢ä¸­...')
                .fontSize(16)
                .margin({left: 8})
            }
            .margin({top: 16, bottom: 16})
          }

          if (this.errorMsg.length > 0) {
            Text(this.errorMsg)
              .fontSize(14)
              .fontColor('#FF0000')
              .width('90%')
              .margin({top: 16, bottom: 16})
              .padding(12)
              .backgroundColor('#FFEBEE')
              .borderRadius(8)
          }

          // æœç´¢ç»“æœéƒ¨åˆ†æ”¹è¿›
          if (this.showResults) {
            Column() {
              Text('æœç´¢ç»“æœ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .alignSelf(ItemAlign.Start)
                .margin({bottom: 16})

              if (this.searchResults.length > 0) {
                Text(`æ‰¾åˆ° ${this.searchResults.length} ä¸ªç›¸ä¼¼æ–‡ç‰©`)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({bottom: 12})
                  
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯ä»¥æ£€æŸ¥ç»“æœ
                Text(`è°ƒè¯•: æ˜¾ç¤º ${this.searchResults.length} ä¸ªç»“æœ`)
                  .fontSize(12)
                  .fontColor('#999999')
                  .alignSelf(ItemAlign.Start)
                  .margin({bottom: 8})
                  
                ForEach(this.searchResults, (item: Artifact) => {
                  // æ‰“å°æ¯ä¸ªæ–‡ç‰©é¡¹ä»¥ä¾¿è°ƒè¯•
                  // console.info(`æ¸²æŸ“æ–‡ç‰©é¡¹: ID=${item.id}, åç§°=${item.name}`);
                  
                  ArtifactItem({
                    artifact: item,
                    onItemClick: (artifact: Artifact) => {
                      this.navigateToDetail(artifact);
                    }
                  })
                })
              } else {
                Column() {
                  Text('ğŸ“·')
                    .fontSize(50)
                    .fontColor('#CCCCCC')
                    .margin({top: 40, bottom: 20})

                  Text('æœªæ‰¾åˆ°ç›¸ä¼¼æ–‡ç‰©')
                    .fontSize(16)
                    .fontColor('#999999')
                    .margin({bottom: 40})
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
              }
            }
            .width('100%')
            .padding({left: 16, right: 16, bottom: 20})
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }

  // æµ‹è¯•å¤‡ç”¨å›¾åƒæœç´¢ç«¯ç‚¹
  async testAlternativeImageSearch() {
    // ç¡®ä¿æœ‰å›¾åƒæ•°æ®
    if (!this.selectedImageData) {
      await this.useSampleImage();
    }

    try {
      this.isLoading = true;
      this.errorMsg = '';
      this.showResults = false;

      // å†æ¬¡éªŒè¯éç©º
      if (!this.selectedImageData) {
        throw new Error("æ— æ³•åˆ›å»ºå›¾åƒæ•°æ®");
      }

      const url = ApiConstants.getFullUrl(ApiConstants.API_IMAGE_SEARCH_ALT); // ä½¿ç”¨å¸¸é‡ä¸­å®šä¹‰çš„å¤‡ç”¨ç«¯ç‚¹
      console.info(`æµ‹è¯•å¤‡ç”¨ç«¯ç‚¹: ${url}`);

      const requestOptions: http.HttpRequestOptions = {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'image/jpeg',
          'Accept': 'application/json'
        },
        // ä¿®å¤ç±»å‹é—®é¢˜ï¼šä½¿ç”¨.bufferå±æ€§è·å–ArrayBuffer
        extraData: this.selectedImageData.buffer, // ä¿®å¤ç±»å‹é”™è¯¯
        connectTimeout: 30000,
        readTimeout: 30000
      };

      const response = await this.httpRequest.request(url, requestOptions);
      console.info(`å¤‡ç”¨ç«¯ç‚¹æµ‹è¯•å“åº”ï¼ŒçŠ¶æ€ç : ${response.responseCode}`);

      if (response.responseCode === 200) {
        promptAction.showToast({ message: 'å¤‡ç”¨ç«¯ç‚¹æµ‹è¯•æˆåŠŸ!' });
        // å¤„ç†ç»“æœ
        const resultStr = response.result ? response.result.toString() : '{}';
        const result: ApiResponse = JSON.parse(resultStr);

        if (result.success && Array.isArray(result.data)) {
          this.searchResults = result.data;
          this.showResults = true;
        }
      } else {
        this.errorMsg = `å¤‡ç”¨ç«¯ç‚¹è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.responseCode}`;
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : JSON.stringify(error);
      this.errorMsg = `å¤‡ç”¨ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${errorMsg}`;
    } finally {
      this.isLoading = false;
    }
  }
}
