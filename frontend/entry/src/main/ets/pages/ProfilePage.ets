import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import http from '@ohos.net.http';
import ApiConstants from '../common/constants/ApiConstants';
import { CommonTabBar } from '../common/components/CommonTabBar';
import { UserService } from '../common/utils/UserService';

interface User {
  userId: number;
  username: string;
  email: string;
  registerTime: string;
}

interface HttpError {
  code?: number;
  message?: string;
}

interface MenuItem {
  title: string;
  icon: Resource | string;
  route: string;
}

// æ·»åŠ æ˜ç¡®çš„æ¥å£ç±»å‹å®šä¹‰
interface ApiResponse {
  success: boolean;
  message?: string;
  data?: User;
}

@Entry
@Component
struct ProfilePage {
  @State isLoggedIn: boolean = false;
  @State user: User = { userId: 0, username: 'æ¸¸å®¢', email: '', registerTime: '' };
  @State currentUserId: number = 0;
  private httpRequest = http.createHttp();
  private userService: UserService = UserService.getInstance();
  
  // èœå•é¡¹å®šä¹‰
  private menuItems: MenuItem[] = [
    { title: 'æˆ‘çš„æ”¶è—', icon: 'â¤ï¸', route: 'pages/MyCollectionsPage' },
    { title: 'æµè§ˆå†å²', icon: 'ğŸ•’', route: 'pages/BrowseHistoryPage' },
    { title: 'æˆ‘çš„è¯„è®º', icon: 'ğŸ’¬', route: 'pages/MyCommentsPage' },
    { title: 'æˆ‘çš„ç‚¹èµ', icon: 'ğŸ‘', route: 'pages/MyLikesPage' },
    { title: 'ç³»ç»Ÿè®¾ç½®', icon: 'âš™ï¸', route: 'pages/SettingsPage' }
  ];
  
  aboutToAppear() {
    // ä»ç”¨æˆ·æœåŠ¡è·å–å½“å‰ç”¨æˆ·ID
    this.currentUserId = this.userService.getCurrentUserId();
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
    this.checkLoginStatus();
  }
  
  // æ·»åŠ onPageShowç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå½“é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶éƒ½ä¼šè§¦å‘
  onPageShow() {
    // é‡æ–°è·å–ç”¨æˆ·IDå¹¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
    this.currentUserId = this.userService.getCurrentUserId();
    this.checkLoginStatus();
    console.info('ProfilePage onPageShow: åˆ·æ–°ç”¨æˆ·ä¿¡æ¯');
  }
  
  aboutToDisappear() {
    this.httpRequest.destroy();
  }
  
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  checkLoginStatus() {
    // æ ¹æ®å½“å‰ç”¨æˆ·IDåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
    this.isLoggedIn = this.currentUserId > 0;
    
    if (this.isLoggedIn) {
      this.getUserInfo();
    }
  }
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo() {
    // æ„å»ºAPI URLï¼ŒåŒ…å«ç”¨æˆ·ID
    const url = ApiConstants.getFullUrl(`${ApiConstants.API_USER_INFO}/${this.currentUserId}`);
    
    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json'
          },
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              // æ·»åŠ æ˜ç¡®çš„ç±»å‹æ ‡æ³¨
              const result: ApiResponse = JSON.parse(resultStr);
              
              if (result.success && result.data) {
                this.user = result.data;
                console.info(`è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ: ç”¨æˆ·ID=${this.user.userId}`);
              } else {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
              }
            } catch (e) {
              console.error(`è§£æç”¨æˆ·ä¿¡æ¯å¼‚å¸¸: ${e.toString()}`);
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            console.error(`è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚å¤±è´¥: ${errMsg}`);
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
    }
  }
  
  // é€€å‡ºç™»å½•
  logout() {
    // æ¸…é™¤ç™»å½•çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯
    this.isLoggedIn = false;
    this.user = { userId: 0, username: 'æ¸¸å®¢', email: '', registerTime: '' };
    this.currentUserId = 0;
    
    // é‡ç½®ç”¨æˆ·æœåŠ¡ä¸­çš„ç”¨æˆ·ID
    this.userService.resetUserId();
    
    // è·³è½¬åˆ°ç™»å½•é¡µé¢
    router.pushUrl({
      url: 'pages/LoginPage'
    });
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('ä¸ªäººä¸­å¿ƒ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.Center)
      
      // ä¸»è¦å†…å®¹åŒºåŸŸåŒ…è£…åœ¨Scrollä¸­ï¼Œä»¥ç¡®ä¿å†…å®¹å¯æ»šåŠ¨ï¼Œä¸ä¼šå½±å“åº•éƒ¨å¯¼èˆªæ å®šä½
      Scroll() {
        Column() {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          Column() {
            Row() {
              // å¤´åƒ
              Image($r('app.media.app_icon'))
                .width(80)
                .height(80)
                .borderRadius(40)
                .backgroundColor('#F0F0F0')
              
              // ç”¨æˆ·åå’Œæ³¨å†Œæ—¶é—´
              Column() {
                Text(this.user.username)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 8 })
                
                Text(this.user.email || '')
                  .fontSize(14)
                  .fontColor('#666666')
                
                if (this.isLoggedIn) {
                  Row() {
                    Text(`ç”¨æˆ·ID: ${this.user.userId}`)
                      .fontSize(14)
                      .fontColor('#FF6A00')
                      .fontWeight(FontWeight.Bold)
                      .margin({ top: 4 })
                  }
                  
                  Text(this.user.registerTime ? `æ³¨å†Œæ—¶é—´: ${this.user.registerTime}` : '')
                    .fontSize(12)
                    .fontColor('#999999')
                    .margin({ top: 4 })
                }
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 16 })
            }
            .width('100%')
            .padding(16)
              if (this.isLoggedIn) {
              // æ·»åŠ ç¼–è¾‘ä¸ªäººèµ„æ–™æŒ‰é’®
              Button('ç¼–è¾‘ä¸ªäººèµ„æ–™')
                .width('90%')
                .height(40)
                .borderRadius(20)
                .backgroundColor('#4E86FF')
                .fontColor(Color.White)
                .fontSize(14)
                .margin({ top: 16, bottom: 8 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/UserProfileEditPage',
                    params: {
                      userId: this.currentUserId
                    }
                  });
                })
              
              Button('é€€å‡ºç™»å½•')
                .width('90%')
                .height(40)
                .borderRadius(20)
                .backgroundColor('#FF4D4F')
                .fontColor(Color.White)
                .fontSize(14)
                .margin({ top: 8, bottom: 16 })
                .onClick(() => {
                  this.logout();
                })
            } else {
              Button('å»ç™»å½•')
                .width('90%')
                .height(40)
                .borderRadius(20)
                .backgroundColor('#4E86FF')
                .fontColor(Color.White)
                .fontSize(14)
                .margin({ top: 16, bottom: 16 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/LoginPage'
                  });
                })
            }
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .margin({ top: 16, bottom: 24 })
          .shadow({ radius: 8, color: '#0000001A', offsetX: 0, offsetY: 2 })
          
          // åŠŸèƒ½èœå•åˆ—è¡¨
          List() {
            ForEach(this.menuItems, (item: MenuItem) => {
              ListItem() {
                Row() {
                  // å›¾æ ‡
                  Text(item.icon)
                    .fontSize(24)
                    .margin({ right: 16 })
                  
                  // æ ‡é¢˜
                  Text(item.title)
                    .fontSize(16)
                    .layoutWeight(1)
                  
                  // ç®­å¤´
                  Text('>')
                    .fontSize(16)
                    .fontColor('#CCCCCC')
                }
                .width('100%')
                .height(56)
                .padding({ left: 24, right: 24 })
                .onClick(() => {                  if (this.isLoggedIn || item.title === 'ç³»ç»Ÿè®¾ç½®') {
                    if (item.title === 'æˆ‘çš„è¯„è®º' || item.title === 'æˆ‘çš„ç‚¹èµ' || item.title === 'æˆ‘çš„æ”¶è—' || item.title === 'æµè§ˆå†å²') {
                      // ä¼ é€’å½“å‰ç”¨æˆ·ID
                      router.pushUrl({
                        url: item.route,
                        params: {
                          userId: this.currentUserId
                        }
                      });
                    } else {
                      router.pushUrl({
                        url: item.route
                      });
                    }
                  } else {
                    promptAction.showToast({
                      message: 'è¯·å…ˆç™»å½•'
                    });
                  }
                })
              }
            })
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .divider({ strokeWidth: 1, color: '#F5F5F5' })
          .shadow({ radius: 8, color: '#0000001A', offsetX: 0, offsetY: 2 })
          
          // ç‰ˆæœ¬ä¿¡æ¯
          Text('ç‰ˆæœ¬: 1.0.0')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 40, bottom: 20 })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
      .layoutWeight(1) // å ç”¨å‰©ä½™ç©ºé—´
      .scrollBar(BarState.Off)
      
      // æ·»åŠ åº•éƒ¨å¯¼èˆªæ 
      CommonTabBar({ currentIndex: 2 }) // 1ä»£è¡¨ä¸ªäººä¸­å¿ƒ
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}