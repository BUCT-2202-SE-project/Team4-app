import router from '@ohos.router';
import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
import ApiConstants from '../common/constants/ApiConstants';
import { UserService } from '../common/utils/UserService';

// å®šä¹‰HTTPé”™è¯¯ç±»å‹
interface HttpError {
  code?: number;
  message?: string;
}

// å®šä¹‰æ–‡ç‰©æ¥å£
interface Artifact {
  artifactId: number;
  name: string;
  era: string;
  type: string;
  museum: string;
  description: string;
  imageUrl: string;
  likes: number;
  feature?: string;
  id?: number; // æ·»åŠ å¯é€‰çš„idå±æ€§ï¼Œå…¼å®¹ä¸åŒæ¥å£
}

// æ‰©å±•æ–‡ç‰©æ¥å£ï¼Œå…¼å®¹ä¸‹åˆ’çº¿å‘½åçº¦å®šçš„å­—æ®µ
interface ExtendedArtifact extends Artifact {
  artifact_id?: number; // å¯èƒ½å­˜åœ¨çš„ä¸‹åˆ’çº¿é£æ ¼å‘½åçš„IDå­—æ®µ
}

// APIå“åº”æ¥å£å®šä¹‰
interface ApiResponse {
  success: boolean;
  message?: string;
  data?: boolean | number | string | Array<Artifact>;
}

// æ–‡ç‰©é¡¹ç»„ä»¶
@Component
struct ArtifactItem {
  private artifact: Artifact = {
    artifactId: 0,
    name: '',
    era: '',
    type: '',
    museum: '',
    description: '',
    imageUrl: '',
    likes: 0
  };
  private onItemClick: (artifact: Artifact) => void = () => {};
  private onUnlikeClick: (artifactId: number) => void = () => {};

  build() {
    Column() {
      Row() {
        // æ–‡ç‰©å›¾ç‰‡ï¼ˆæˆ–å ä½å›¾ï¼‰
        Stack() {
          if (this.artifact.imageUrl) {
            Image(this.artifact.imageUrl)
              .width(120)
              .height(120)
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
          } else {
            // å ä½å›¾
            Column() {
            }
            .width(120)
            .height(120)
            .backgroundColor('#DDDDDD')
            .borderRadius(8)
          }
        }
        .margin({ right: 16 })

        // æ–‡ç‰©ä¿¡æ¯
        Column() {
          Text(this.artifact.name || 'æœªå‘½åæ–‡ç‰©')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 8 })

          Row() {
            Text('æœä»£: ')
              .fontSize(14)
              .fontColor('#666666')
            Text(this.artifact.era || 'æœªçŸ¥')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
          }
          .margin({ bottom: 6 })
          .width('100%')
          Row() {
            Text('ç±»å‹: ')
              .fontSize(14)
              .fontColor('#666666')
            Text(this.artifact.type || 'æœªçŸ¥')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
          }
          .margin({ bottom: 6 })
          .width('100%')

          Row() {
            Text('åšç‰©é¦†: ')
              .fontSize(14)
              .fontColor('#666666')
            Text(this.artifact.museum || 'æœªçŸ¥')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
          }
          .margin({ bottom: 6 })
          .width('100%')

          // æ“ä½œæŒ‰é’®
          Row() {
            Button() {
              Row() {
                Text('ğŸ‘ ')
                  .fontSize(16)
                  .fontColor('#FF4D4F')
                Text('å–æ¶ˆç‚¹èµ')
                  .fontSize(12)
                  .fontColor('#FF4D4F')
              }
            }
            .backgroundColor('transparent')
            .height(28)
            .border({
              color: '#FF4D4F',
              width: 1
            })
            .borderRadius(14)
            .onClick(() => {
              this.onUnlikeClick(this.artifact.artifactId);
            })

            Button('æŸ¥çœ‹è¯¦æƒ…')
              .fontSize(12)
              .fontColor('#4E86FF')
              .backgroundColor('transparent')
              .height(28)
              .margin({ left: 8 })
              .border({
                color: '#4E86FF',
                width: 1
              })
              .borderRadius(14)
              .onClick(() => {
                this.onItemClick(this.artifact);
              })
          }
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .padding(16)
    .borderRadius(12)
    .backgroundColor('#FFFFFF')
    .onClick(() => {
      this.onItemClick(this.artifact);
    })
  }
}

@Entry
@Component
struct MyLikesPage {
  @State likedArtifacts: Array<Artifact> = [];
  @State isLoading: boolean = true;
  @State errorMsg: string = '';
  @State userId: number = 0;  // æ·»åŠ ç”¨æˆ·IDçŠ¶æ€

  private httpRequest = http.createHttp();
  private userService: UserService = UserService.getInstance();

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°ä¸­çš„userId
    const params = router.getParams() as Record<string, number | string>;
    if (params && params.userId) {
      // å¦‚æœè·¯ç”±å‚æ•°ä¸­æœ‰userIdï¼Œåˆ™ä½¿ç”¨è¯¥å‚æ•°
      this.userId = params.userId as number;
      console.info(`ä»è·¯ç”±å‚æ•°è·å–åˆ°ç”¨æˆ·ID: ${this.userId}`);
    } else {
      // å¦åˆ™ä»ç”¨æˆ·æœåŠ¡ä¸­è·å–userId
      this.userId = this.userService.getCurrentUserId();
      console.info(`ä»ç”¨æˆ·æœåŠ¡è·å–åˆ°ç”¨æˆ·ID: ${this.userId}`);
    }

    this.loadLikedArtifacts();
  }

  aboutToDisappear() {
    if (this.httpRequest) {
      this.httpRequest.destroy();
    }
  }

  // åŠ è½½ç‚¹èµçš„æ–‡ç‰©
  loadLikedArtifacts() {
    this.isLoading = true;
    this.errorMsg = '';

    // æ„å»ºAPI URL - æ·»åŠ ç”¨æˆ·IDå‚æ•°
    const url = `${ApiConstants.getFullUrl(ApiConstants.API_LIKES)}?userId=${this.userId}`;

    console.info(`å¼€å§‹è¯·æ±‚ç‚¹èµæ–‡ç‰©æ•°æ®ï¼ŒURL: ${url}ï¼Œç”¨æˆ·ID: ${this.userId}`);
    promptAction.showToast({
      message: 'æ­£åœ¨åŠ è½½ç‚¹èµæ•°æ®...',
      duration: 1500
    });

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': 'Bearer token' // TODO: æ·»åŠ å®é™…token
          },
          connectTimeout: 30000, // 30ç§’è¿æ¥è¶…æ—¶
          readTimeout: 30000     // 30ç§’è¯»å–è¶…æ—¶
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              console.info(`æˆåŠŸæ¥æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç : ${data.responseCode}`);

              const resultStr = data.result ? data.result.toString() : '[]';
              console.info(`è½¬æ¢ä¸ºå­—ç¬¦ä¸²: ${resultStr.substring(0, 100)}...`); // åªè®°å½•å‰100ä¸ªå­—ç¬¦é¿å…æ—¥å¿—è¿‡é•¿

              const result: Array<Artifact> = JSON.parse(resultStr);
              if (Array.isArray(result)) {
                // æ‰“å°ç¬¬ä¸€ä¸ªå¯¹è±¡çš„å®Œæ•´ç»“æ„ï¼Œå¸®åŠ©è°ƒè¯•
                if(result.length > 0) {
                  console.info(`ç¬¬ä¸€ä¸ªç‚¹èµæ–‡ç‰©å®Œæ•´æ•°æ®: ${JSON.stringify(result[0])}`);
                  console.info(`å¯ç”¨çš„å±æ€§: ${Object.keys(result[0]).join(', ')}`);
                }
                
                // ä¿®å¤ï¼šé¿å…ä½¿ç”¨æœªç±»å‹åŒ–çš„å¯¹è±¡å­—é¢é‡
                this.likedArtifacts = result.map(item => {
                  // ä¸åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ”¹åŸå§‹å¯¹è±¡
                  // å°è¯•ä»å„ç§å¯èƒ½çš„å­—æ®µåè·å–ID
                  const rawData = JSON.stringify(item);
                  const match = rawData.match(/"artifact_id":(\d+)/);
                  const rawId = match ? parseInt(match[1]) : null;
                  
                  // ä½¿ç”¨å·²å®šä¹‰çš„IDå­—æ®µæˆ–ä»åŸå§‹JSONæå–çš„ID
                  const potentialId = item.id || item.artifactId || rawId;
                  
                  console.info(`æ–‡ç‰©[${item.name}] IDæå–: artifactId=${item.artifactId}, id=${item.id}, æå–ID=${potentialId}`);
                  
                  // ç›´æ¥ä¿®æ”¹åŸå§‹å¯¹è±¡ï¼Œä¸åˆ›å»ºæ‹·è´
                  if (potentialId) {
                    item.id = potentialId;
                    item.artifactId = potentialId;
                    console.info(`æ–‡ç‰©[${item.name}] IDå·²æ›´æ–°: artifactId=${item.artifactId}, id=${item.id}`);
                  }
                  
                  return item;
                });
                console.info(`æˆåŠŸè§£æä¸ºæ•°ç»„ï¼ŒåŒ…å«${this.likedArtifacts.length}ä¸ªç‚¹èµé¡¹ç›®`);

                if (this.likedArtifacts.length === 0) {
                  console.warn('è·å–åˆ°ç©ºæ•°ç»„ï¼Œæ²¡æœ‰ç‚¹èµæ•°æ®');
                  this.errorMsg = 'æš‚æ— ç‚¹èµæ•°æ®';
                  promptAction.showToast({
                    message: 'æš‚æ— ç‚¹èµæ•°æ®',
                    duration: 2000
                  });
                } else {
                  promptAction.showToast({
                    message: `å·²åŠ è½½${this.likedArtifacts.length}ä¸ªç‚¹èµæ–‡ç‰©`,
                    duration: 2000
                  });
                }
              } else {
                console.error(`APIè¿”å›çš„æ•°æ®ä¸æ˜¯æ•°ç»„: ${typeof result}`);
                this.errorMsg = 'æ•°æ®æ ¼å¼é”™è¯¯ï¼šè¿”å›çš„ä¸æ˜¯æ•°ç»„';
                this.likedArtifacts = [];
                promptAction.showToast({
                  message: 'æ•°æ®æ ¼å¼é”™è¯¯',
                  duration: 2000
                });
              }
            } catch (e) {
              console.error(`è§£æå“åº”å¤±è´¥: ${e.toString()}`);
              console.error(`åŸå§‹å“åº”æ•°æ®: ${data.result?.toString().substring(0, 200) || 'ç©º'}`);
              this.errorMsg = `è§£ææ•°æ®å¤±è´¥: ${e.toString()}`;
              this.likedArtifacts = [];
              promptAction.showToast({
                message: 'è§£ææ•°æ®å¤±è´¥',
                duration: 2000
              });
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            const respCode = data ? data.responseCode.toString() : 'N/A';
            let respBody = '';

            // å°è¯•è·å–å“åº”ä½“ä»¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
            if (data && data.result) {
              try {
                respBody = data.result.toString();
                console.error(`å“åº”ä½“: ${respBody}`);
              } catch (e) {
                console.error(`æ— æ³•è¯»å–å“åº”ä½“: ${e.toString()}`);
              }
            }

            console.error(`è¯·æ±‚å¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}, å“åº”ä½“: ${respBody}`);
            this.errorMsg = `ç½‘ç»œè¯·æ±‚å¤±è´¥: ${errMsg}, å“åº”ç : ${respCode}`;
            this.likedArtifacts = [];
            promptAction.showToast({
              message: `ç½‘ç»œé”™è¯¯: ${errMsg}`,
              duration: 3000
            });
          }
          this.isLoading = false;
        }
      );
    } catch (e) {
      console.error(`å‘èµ·è¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      this.errorMsg = `å‘èµ·è¯·æ±‚å¼‚å¸¸: ${e.toString()}`;
      this.isLoading = false;
      this.likedArtifacts = [];
      promptAction.showToast({
        message: 'ç½‘ç»œè¿æ¥å¼‚å¸¸',
        duration: 3000
      });
    }
  }

  // å–æ¶ˆç‚¹èµ
  unlikeArtifact(artifactId: number) {
    const url = ApiConstants.getFullUrl(ApiConstants.API_UNLIKE);

    try {
      this.httpRequest.request(
        url,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer token' // TODO: æ·»åŠ å®é™…token
          },
          extraData: JSON.stringify({
            artifactId: artifactId
          }),
          connectTimeout: 30000,
          readTimeout: 30000
        },
        (err: HttpError | null, data: http.HttpResponse) => {
          if (!err && data.responseCode === 200) {
            try {
              const resultStr = data.result ? data.result.toString() : '{}';
              const result: ApiResponse = JSON.parse(resultStr);

              if (result.success) {
                promptAction.showToast({
                  message: 'å–æ¶ˆç‚¹èµæˆåŠŸ',
                  duration: 2000
                });

                // ä»åˆ—è¡¨ä¸­ç§»é™¤
                this.likedArtifacts = this.likedArtifacts.filter(item => item.artifactId !== artifactId);
              } else {
                promptAction.showToast({
                  message: result.message || 'å–æ¶ˆç‚¹èµå¤±è´¥',
                  duration: 2000
                });
              }
            } catch (e) {
              console.error(`è§£æå–æ¶ˆç‚¹èµå“åº”å¤±è´¥: ${e.toString()}`);
              promptAction.showToast({
                message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•',
                duration: 2000
              });
            }
          } else {
            const errMsg = err ? err.message : 'æœªçŸ¥é”™è¯¯';
            console.error(`å–æ¶ˆç‚¹èµè¯·æ±‚å¤±è´¥: ${errMsg}`);
            promptAction.showToast({
              message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
              duration: 2000
            });
          }
        }
      );
    } catch (e) {
      console.error(`å‘èµ·å–æ¶ˆç‚¹èµè¯·æ±‚å¼‚å¸¸: ${e.toString()}`);
      promptAction.showToast({
        message: 'ç½‘ç»œè¿æ¥å¼‚å¸¸',
        duration: 2000
      });
    }
  }

  // ç®€åŒ–navigateToDetailæ–¹æ³•ï¼Œä¸è¯„è®ºé¡µé¢ä¿æŒä¸€è‡´
  navigateToDetail(artifact: Artifact) {
    // ç›´æ¥ç¡¬ç¼–ç IDä»æ–‡ç‰©åç§°ä¸­è·å–
    // è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶æ–¹æ¡ˆï¼Œæ ¹æ®æ–‡ç‰©åç§°æå–ID
    // å‡è®¾æ–‡ç‰©åç§°åŒ…å«ä¸€ä¸ªåºå·æ¨¡å¼
    let artifactId: number | undefined = undefined;
    
    if (artifact.name) {
      // ä»åç§°ä¸­æå–æ•°å­—ä½œä¸ºID
      const nameMatch = artifact.name.match(/\d+/);
      if (nameMatch) {
        artifactId = parseInt(nameMatch[0]);
        console.info(`ä»åç§°[${artifact.name}]ä¸­æå–åˆ°ID: ${artifactId}`);
      }
    }
    
    // å°è¯•å„ç§IDå­—æ®µ
    artifactId = artifact.artifactId || artifact.id || artifactId;
    
    console.info(`å‡†å¤‡è·³è½¬åˆ°æ–‡ç‰©è¯¦æƒ…ï¼Œæœ€ç»ˆç¡®å®šçš„ID: ${artifactId}`);
    
    if (artifactId) {
      router.pushUrl({
        url: 'pages/ArtifactDetailPage',
        params: {
          artifactId: artifactId  // ä¸è¯„è®ºé¡µé¢ç”¨åŒåå‚æ•°
        }
      });
    } else {
      console.error(`æ— æ³•æ‰¾åˆ°æ–‡ç‰©IDï¼Œæ— æ³•è·³è½¬: ${artifact.name}`);
      promptAction.showToast({
        message: 'æ— æ³•æŸ¥çœ‹è¯¦æƒ…ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›æŒ‰é’®
        Button({ type: ButtonType.Normal }) {
          Text('â†')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .height(40)
        .width(40)
        .backgroundColor('transparent')
        .onClick(() => {
          router.back();
        })

        // æ ‡é¢˜
        Text('æˆ‘çš„ç‚¹èµ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å³ä¾§å ä½ï¼Œä¿æŒå¸ƒå±€å¯¹ç§°
        Button({ type: ButtonType.Normal }) {
          Text('')
        }
        .height(40)
        .width(40)
        .backgroundColor('transparent')
        .opacity(0)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#FFFFFF')

      // ä¸»ä½“å†…å®¹
      if (this.isLoading) {
        // åŠ è½½ä¸­æ˜¾ç¤º
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ top: 8 })
        }
        .height('100%')
        .width('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.likedArtifacts.length === 0) {
        // æ— æ•°æ®æ˜¾ç¤º
        Column() {
          Text('æš‚æ— ç‚¹èµæ–‡ç‰©')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ bottom: 16 })

          Button('å»æ–‡ç‰©åˆ—è¡¨çœ‹çœ‹')
            .fontSize(16)
            .height(40)
            .backgroundColor('#4E86FF')
            .borderRadius(20)
            .onClick(() => {
              console.info('è·³è½¬åˆ°æ–‡ç‰©åˆ—è¡¨é¡µ');
              try {
                router.replaceUrl({
                  url: 'pages/ArtifactListPage'
                }).then(() => {
                  console.info('æˆåŠŸè·³è½¬åˆ°æ–‡ç‰©åˆ—è¡¨é¡µ');
                // }).catch((e) => {
                //   console.error(`è·³è½¬åˆ°æ–‡ç‰©åˆ—è¡¨é¡µå¤±è´¥: ${JSON.stringify()}`);
                //   promptAction.showToast({
                //     message: 'è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•',
                //     duration: 2000
                //   });
                });
              } catch (e) {
                console.error(`è·³è½¬å‡ºç°å¼‚å¸¸: ${e instanceof Error ? e.message : JSON.stringify(e)}`);
                promptAction.showToast({
                  message: 'è·³è½¬å¼‚å¸¸ï¼Œè¯·é‡è¯•',
                  duration: 2000
                });
              }
            })
        }
        .height('80%')
        .width('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // ç‚¹èµåˆ—è¡¨
        List() {
          ForEach(this.likedArtifacts, (item: Artifact) => {
            ListItem() {
              ArtifactItem({
                artifact: item,
                onItemClick: (artifact: Artifact) => {
                  this.navigateToDetail(artifact);
                },
                onUnlikeClick: (artifactId: number) => {
                  this.unlikeArtifact(artifactId);
                }
              })
            }
            .margin({ bottom: 12 })
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}